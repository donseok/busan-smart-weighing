# 부산 스마트 계량 시스템 - 기능 명세서 (Functional Specification)

**버전**: 1.0
**작성일**: 2026-01-27
**기반 문서**: PRD-20260127-154446, TRD-20260127-155235, WBS-20260127-160043
**상태**: Draft

---

## 목차

1. [문서 개요](#1-문서-개요)
2. [모듈 1: LPR 차량번호 인식 시스템](#2-모듈-1-lpr-차량번호-인식-시스템)
3. [모듈 2: 스마트 계량 웹 관리 시스템](#3-모듈-2-스마트-계량-웹-관리-시스템)
4. [모듈 3: 계량 CS 프로그램](#4-모듈-3-계량-cs-프로그램)
5. [모듈 4: 계량관리 모바일 APP](#5-모듈-4-계량관리-모바일-app)
6. [모듈 5: 모바일 API](#6-모듈-5-모바일-api)
7. [모듈 6: H/W 인프라 연동](#7-모듈-6-hw-인프라-연동)
8. [모듈 7: 유선통화 이원화 시스템](#8-모듈-7-유선통화-이원화-시스템)
9. [요구사항 추적 매트릭스](#9-요구사항-추적-매트릭스)

---

## 1. 문서 개요

### 1.1 목적
본 문서는 부산 스마트 계량 시스템의 PRD, TRD, WBS를 기반으로 각 기능의 상세 동작을 정의한다. 개발, 테스트, 검수의 기준 문서로 사용한다.

### 1.2 범위
PRD FR-001 ~ FR-008의 모든 기능 요구사항을 7개 모듈로 분류하여 상세 명세한다.

### 1.3 용어
| 용어 | 정의 |
|------|------|
| LPR | License Plate Recognition - 차량번호판 자동인식 장치 |
| OTP | One-Time Password - 일회용 보안 비밀번호 |
| LiDAR | Light Detection and Ranging - 라이다 센서 |
| 인디게이터 | 계량대에서 중량값을 표시하는 장치 |
| 전자 계량표 | 모바일 APP으로 제공되는 디지털 계량 증빙 |
| 배차 | 차량 운송 스케줄 배정 |

---

## 2. 모듈 1: LPR 차량번호 인식 시스템

### FUNC-001: LPR 차량번호 자동 촬영

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-001 |
| **기능명** | LPR 차량번호 자동 촬영 |
| **PRD 매핑** | FR-001 |
| **모듈** | LPR 차량번호 인식 시스템 |
| **우선순위** | HIGH |

**기능 설명**: LiDAR/레이더 센서가 차량 진입을 감지하면 LPR 카메라가 차량번호판을 자동 촬영한다.

**선행 조건 (Preconditions)**:
- LPR 카메라가 정상 동작 상태
- LiDAR/레이더 센서가 정상 연결 상태
- 계량대 CS 프로그램이 실행 중

**후행 조건 (Postconditions)**:
- 촬영 이미지가 서버에 저장됨
- AI 검증 프로세스가 트리거됨

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| sensor_event | string | Y | LiDAR/레이더 감지 이벤트 신호 |
| scale_id | bigint | Y | 계량대 식별자 |
| timestamp | timestamptz | Y | 감지 시각 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| lpr_image_path | string | 촬영 이미지 저장 경로 |
| raw_plate_number | string | LPR 1차 인식 차량번호 |
| capture_timestamp | timestamptz | 촬영 시각 |

**비즈니스 규칙**:
- BR-001-1: LiDAR/레이더 센서 감지 시점에 LPR 촬영을 트리거한다
- BR-001-2: 촬영 이미지는 NAS에 90일간 보관한다 (TRD 백업 정책)
- BR-001-3: 1대의 차량에 대해 중복 촬영 방지 (최소 10초 간격)

**정상 흐름 (Main Flow)**:
1. LiDAR/레이더 센서가 차량 진입을 감지한다
2. 센서 이벤트가 계량대 CS 프로그램으로 TCP/UDP 전송된다
3. CS 프로그램이 LPR 카메라에 촬영 명령을 전송한다
4. LPR 카메라가 차량번호판을 촬영한다
5. LPR 장치가 1차 인식 결과(raw_plate_number)를 반환한다
6. CS 프로그램이 촬영 이미지와 1차 인식 결과를 API 서버로 전송한다
7. API 서버가 AI 검증 엔진에 이미지를 전달한다

**대안 흐름 (Alternative Flow)**:
- AF-001-1: LPR 1차 인식 실패 시 2회 재촬영 시도 (1초 간격)
- AF-001-2: 야간 촬영 시 보조 조명 자동 점등

**예외 흐름 (Exception Flow)**:
- EF-001-1: LPR 카메라 연결 끊김 → CS 프로그램에 경고 표시, 수동 계량 모드 전환 안내
- EF-001-2: 센서 감지 오류(차량 미존재) → 촬영 결과 폐기, 로그 기록
- EF-001-3: 3회 연속 촬영 실패 → 관리자 알림 발송, H/W 점검 요청

**UI/UX 요구사항**:
- CS 프로그램 메인 화면에 LPR 촬영 상태 표시 (대기/촬영중/완료/오류)
- 촬영 이미지 실시간 미리보기

**연관 기능**: FUNC-002 (AI 차량번호 검증), FUNC-010 (센서 연동)

**비기능 요구사항 매핑**:
- NFR-001 성능: LPR 촬영 → AI 검증 → 결과 반환 3초 이내
- NFR-004 가용성: LPR 장비 장애 시 수동 모드 전환

---

### FUNC-002: AI 차량번호 검증

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-002 |
| **기능명** | AI 차량번호 검증 |
| **PRD 매핑** | FR-001 |
| **모듈** | LPR 차량번호 인식 시스템 |
| **우선순위** | HIGH |

**기능 설명**: LPR 1차 인식 결과를 AI 엔진이 재검증하여 차량번호를 확정하고, 신뢰도 점수를 산출한다.

**선행 조건 (Preconditions)**:
- LPR 촬영 이미지가 존재
- AI 인식 엔진이 정상 가동 상태
- API 서버가 정상 동작

**후행 조건 (Postconditions)**:
- 차량번호 확정 및 신뢰도 저장
- 배차 자동 매칭 프로세스 트리거

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| lpr_image | binary | Y | 촬영 이미지 파일 |
| raw_plate_number | string | Y | LPR 1차 인식 결과 |
| scale_id | bigint | Y | 계량대 식별자 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| confirmed_plate_number | string | AI 확정 차량번호 |
| ai_confidence | decimal(5,4) | 신뢰도 (0.0~1.0) |
| verification_status | string | CONFIRMED / LOW_CONFIDENCE / FAILED |

**비즈니스 규칙**:
- BR-002-1: ai_confidence >= 0.90 → CONFIRMED (자동 계량 진행)
- BR-002-2: 0.70 <= ai_confidence < 0.90 → LOW_CONFIDENCE (전광판 OTP 안내, 모바일 OTP 프로세스)
- BR-002-3: ai_confidence < 0.70 → FAILED (전광판 OTP 안내, 모바일 OTP 필수)
- BR-002-4: 전체 인식률 95% 이상 목표

**정상 흐름 (Main Flow)**:
1. API 서버가 LPR 이미지를 AI 엔진에 HTTPS로 전송한다
2. AI 엔진이 차량번호를 추출하고 신뢰도를 산출한다
3. 결과를 API 서버로 반환한다
4. API 서버가 tb_weighing 테이블에 lpr_plate_number, ai_confidence를 저장한다
5. 신뢰도에 따라 자동계량(CONFIRMED) 또는 OTP 프로세스(LOW_CONFIDENCE/FAILED)를 분기한다

**대안 흐름 (Alternative Flow)**:
- AF-002-1: AI 엔진 응답 지연(3초 초과) → 타임아웃, LPR 1차 결과 사용 + OTP 병행

**예외 흐름 (Exception Flow)**:
- EF-002-1: AI 엔진 서비스 다운 → LPR 1차 결과 사용, 모바일 OTP 필수 전환
- EF-002-2: 이미지 손상/불량 → 재촬영 요청

**연관 기능**: FUNC-001 (LPR 촬영), FUNC-003 (배차 자동 매칭), FUNC-004 (OTP 보안 계량)

**비기능 요구사항 매핑**:
- NFR-001 성능: AI 검증 응답 3초 이내 (E2E 포함)
- NFR-002 보안: AI 엔진 통신 HTTPS 암호화

---

### FUNC-003: 배차 자동 매칭

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-003 |
| **기능명** | 배차 자동 매칭 |
| **PRD 매핑** | FR-001 |
| **모듈** | LPR 차량번호 인식 시스템 |
| **우선순위** | HIGH |

**기능 설명**: AI 확정 차량번호로 당일 배차 정보를 자동 매칭하여 계량을 진행한다.

**선행 조건 (Preconditions)**:
- AI 차량번호 검증 완료 (CONFIRMED 상태)
- 해당 차량의 당일 배차 정보 존재

**후행 조건 (Postconditions)**:
- 배차-계량 실적 연결
- 자동 계량 프로세스 시작

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| confirmed_plate_number | string | Y | AI 확정 차량번호 |
| scale_id | bigint | Y | 계량대 식별자 |
| weighing_date | date | Y | 계량일자 (당일) |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| dispatch_id | bigint | 매칭된 배차 ID |
| vehicle_id | bigint | 차량 ID |
| item_type | string | 품목 유형 |
| dispatch_list | array | 다중 배차 목록 (복수 매칭 시) |

**비즈니스 규칙**:
- BR-003-1: 차량번호로 tb_vehicle에서 vehicle_id 조회 (plate_number UNIQUE 인덱스)
- BR-003-2: vehicle_id + 당일 날짜로 tb_dispatch에서 REGISTERED/IN_PROGRESS 상태 배차 조회
- BR-003-3: 단일 배차 매칭 → 즉시 자동 계량 진행
- BR-003-4: 다중 배차 매칭 → 모바일 APP에서 배차 선택 요청 (전광판 안내)
- BR-003-5: 매칭 배차 없음 → 수동 계량 모드 전환

**정상 흐름 (Main Flow)**:
1. 확정된 차량번호로 tb_vehicle 조회
2. vehicle_id로 당일 활성 배차 조회
3. 단일 배차 → dispatch_id로 계량 시작 (tb_weighing INSERT)
4. 계량대 CS에 자동계량 시작 알림
5. 자동차단기 개방 (계량대 진입 허용)

**대안 흐름 (Alternative Flow)**:
- AF-003-1: 다중 배차 → 전광판에 "모바일 배차 선택" 안내 → 모바일 APP에서 선택
- AF-003-2: 차량 미등록 → 전광판에 "미등록 차량" 안내, 수동 계량 모드

**예외 흐름 (Exception Flow)**:
- EF-003-1: DB 조회 실패 → 수동 계량 모드 전환, 에러 로그 기록

**연관 기능**: FUNC-002 (AI 검증), FUNC-007 (계량 프로세스), FUNC-012 (전광판 제어)

**비기능 요구사항 매핑**:
- NFR-001 성능: 배차 매칭 조회 200ms 이내 (인덱스 활용)
- NFR-003 확장성: 품목 유형 추가 시 변경 최소화

---

### FUNC-004: OTP 보안 계량

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-004 |
| **기능명** | OTP 보안 계량 |
| **PRD 매핑** | FR-002 |
| **모듈** | LPR 차량번호 인식 시스템 |
| **우선순위** | HIGH |

**기능 설명**: 차량번호 오인식 시 전광판에 OTP를 표시하고, 운전자가 모바일 APP에서 OTP를 입력하여 본인 인증 후 계량을 진행한다.

**선행 조건 (Preconditions)**:
- AI 검증 결과가 LOW_CONFIDENCE 또는 FAILED
- 전광판이 정상 동작
- 운전자가 모바일 APP 설치 및 로그인 완료

**후행 조건 (Postconditions)**:
- OTP 검증 완료, 차량 확인
- 모바일 계량 프로세스 진행

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| otp_code | varchar(6) | Y | 6자리 숫자 |
| phone_number | varchar(20) | Y | 등록된 전화번호 형식 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| verified | boolean | 검증 성공 여부 |
| vehicle_id | bigint | 확인된 차량 ID |
| plate_number | string | 확인된 차량번호 |
| dispatch_id | bigint | 매칭 배차 ID |

**비즈니스 규칙**:
- BR-004-1: OTP는 6자리 숫자, Redis에 저장, TTL 5분
- BR-004-2: OTP 생성 시 해당 계량대의 전광판에 표시
- BR-004-3: 전화번호 기반 사용자 → 차량 매칭 (tb_user.phone_number → tb_vehicle)
- BR-004-4: OTP 검증 실패 3회 → 해당 OTP 무효화, 새 OTP 발급
- BR-004-5: OTP 만료 후 → 새 OTP 자동 발급, 전광판 갱신
- BR-004-6: 오계량 방지: 동일 OTP로 중복 계량 불가

**정상 흐름 (Main Flow)**:
1. AI 검증 결과 LOW_CONFIDENCE/FAILED 판정
2. API 서버가 6자리 OTP를 생성하여 Redis에 저장 (TTL 5분)
3. CS 프로그램이 전광판에 OTP 번호를 표시
4. 운전자가 모바일 APP에서 OTP 번호를 입력
5. 모바일 APP이 POST /api/v1/otp/verify 호출
6. 서버가 Redis에서 OTP 조회 및 검증
7. 전화번호로 사용자/차량 매칭
8. 검증 성공 → 배차 매칭 → 모바일 계량 시작
9. OTP Redis 키 삭제 (일회용)

**대안 흐름 (Alternative Flow)**:
- AF-004-1: OTP 만료 → "OTP가 만료되었습니다. 새 OTP가 발급됩니다" → 재발급
- AF-004-2: 전화번호 미등록 → "등록되지 않은 번호입니다. 관리자에게 문의" 안내

**예외 흐름 (Exception Flow)**:
- EF-004-1: Redis 장애 → DB 직접 OTP 조회 Fallback
- EF-004-2: 전광판 고장 → 모바일 APP Push로 OTP 전송
- EF-004-3: 3회 검증 실패 → 수동 계량 전환 안내

**UI/UX 요구사항**:
- 전광판: OTP 번호 대형 표시 (3단6열 특주사양)
- 모바일 APP: OTP 입력 화면, 숫자 키패드, 잔여 시간 타이머 표시

**연관 기능**: FUNC-002 (AI 검증), FUNC-012 (전광판 제어), FUNC-020 (모바일 OTP 화면)

**비기능 요구사항 매핑**:
- NFR-002 보안: OTP TTL 5분, 3회 실패 잠금, Redis 기반 관리
- NFR-001 성능: OTP 검증 API 응답 2초 이내

---

## 3. 모듈 2: 스마트 계량 웹 관리 시스템

### FUNC-005: 배차 등록/관리

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-005 |
| **기능명** | 배차 등록/관리 |
| **PRD 매핑** | FR-004 |
| **모듈** | 스마트 계량 웹 관리 시스템 |
| **우선순위** | HIGH |

**기능 설명**: 계량 담당자가 웹 시스템에서 부산물, 폐기물, 부재료, 반출, 일반 등 품목별 배차를 등록하고 관리한다.

**선행 조건 (Preconditions)**:
- 사용자 로그인 완료 (ADMIN 또는 MANAGER 권한)
- 운송사, 차량 기준정보 등록 완료

**후행 조건 (Postconditions)**:
- tb_dispatch 레코드 생성/수정
- 배차 상태 변경 이력 기록

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| vehicle_id | bigint | Y | 등록된 차량 ID |
| company_id | bigint | Y | 등록된 운송사 ID |
| item_type | varchar(20) | Y | 부산물/폐기물/부재료/반출/일반 중 택 1 |
| item_name | varchar(100) | Y | 품목명 (최대 100자) |
| dispatch_date | date | Y | 미래 또는 당일 날짜 |
| origin_location | varchar(100) | N | 출발지 |
| destination | varchar(100) | N | 도착지 |
| remarks | text | N | 비고 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| dispatch_id | bigint | 생성된 배차 ID |
| dispatch_status | string | REGISTERED |
| created_at | timestamptz | 생성 일시 |

**비즈니스 규칙**:
- BR-005-1: 배차 등록 권한은 ADMIN, MANAGER만 가능
- BR-005-2: 배차 상태 흐름: REGISTERED → IN_PROGRESS → COMPLETED / CANCELLED
- BR-005-3: COMPLETED 상태의 배차는 수정 불가
- BR-005-4: 동일 차량에 동일 날짜 다중 배차 허용 (다중 배차 시나리오)
- BR-005-5: 배차 삭제는 ADMIN만 가능, REGISTERED 상태에서만 가능

**정상 흐름 (Main Flow)**:
1. 담당자가 배차관리 화면 진입
2. "배차 등록" 버튼 클릭
3. 배차 정보 입력 (운송사, 차량, 품목, 날짜 등)
4. "저장" 클릭 → POST /api/v1/dispatches 호출
5. 서버 검증 → tb_dispatch INSERT
6. 배차 목록에 신규 항목 표시

**대안 흐름 (Alternative Flow)**:
- AF-005-1: 기존 배차 복사 등록 → 이전 배차 정보 자동 입력, 날짜만 변경
- AF-005-2: 배차 일괄 등록 → Excel 업로드 방식

**예외 흐름 (Exception Flow)**:
- EF-005-1: 필수 입력값 누락 → 유효성 오류 메시지 표시
- EF-005-2: 미등록 차량번호 → "차량을 먼저 등록해주세요" 안내

**UI/UX 요구사항**:
- Ant Design 데이터 테이블: 필터, 정렬, 소계, 셀고정
- 반응형 디자인: 다양한 디바이스/브라우저 호환
- 고해상도, 가변 SIZE 화면

**연관 기능**: FUNC-008 (기준정보 관리), FUNC-003 (배차 자동 매칭)

**비기능 요구사항 매핑**:
- NFR-001 성능: 배차 목록 조회 3초 이내 (웹 화면 로딩)
- NFR-005 사용성: 필터/정렬/소계/셀고정 편의기능

---

### FUNC-006: 계량 현황 관리

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-006 |
| **기능명** | 계량 현황 관리 |
| **PRD 매핑** | FR-004 |
| **모듈** | 스마트 계량 웹 관리 시스템 |
| **우선순위** | HIGH |

**기능 설명**: 웹 시스템에서 실시간 계량 현황을 모니터링하고, 계량 실적을 조회/관리한다.

**선행 조건 (Preconditions)**:
- 사용자 로그인 완료
- 계량 실적 데이터 존재

**후행 조건 (Postconditions)**:
- 계량 현황 화면 갱신

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| date_from | date | N | 조회 시작일 |
| date_to | date | N | 조회 종료일 |
| item_type | string | N | 품목 유형 필터 |
| weighing_mode | string | N | 계량 방식 필터 (LPR_AUTO/MOBILE_OTP/MANUAL) |
| status | string | N | 계량 상태 필터 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| weighing_list | array | 계량 실적 목록 |
| statistics | object | 통계 정보 (건수, 총중량 등) |
| realtime_status | object | 실시간 계량대 상태 (WebSocket) |

**비즈니스 규칙**:
- BR-006-1: 실시간 계량 현황은 WebSocket(STOMP)으로 500ms 이내 업데이트
- BR-006-2: 계량 목록은 페이징 처리 (기본 20건/페이지)
- BR-006-3: 통계 조회: 일별/월별/품목별 집계 제공
- BR-006-4: 계량 상세 조회 시 LPR 촬영 이미지 표시

**정상 흐름 (Main Flow)**:
1. 담당자가 계량관리 화면 진입
2. WebSocket 연결 수립 (WSS)
3. 실시간 계량 현황 대시보드 표시 (계량대 상태, 진행 중 계량)
4. 조건 설정하여 계량 실적 목록 조회 (REST API)
5. 특정 계량 클릭 → 상세 정보 + LPR 이미지 표시

**대안 흐름 (Alternative Flow)**:
- AF-006-1: WebSocket 연결 실패 → REST 폴링 (5초 간격)
- AF-006-2: 통계/대시보드 → ECharts 차트 표시 (일별 추이, 품목별 비율)

**예외 흐름 (Exception Flow)**:
- EF-006-1: 대량 데이터 조회 → 엑셀 내보내기 안내

**UI/UX 요구사항**:
- ECharts 기반 대시보드 (일별 계량 추이, 품목별 비율, 계량방식별 통계)
- 실시간 계량대 상태 표시 (대기/계량중/완료/오류)
- 데이터 테이블: 필터, 정렬, 페이징, 엑셀 내보내기

**연관 기능**: FUNC-005 (배차 관리), FUNC-007 (계량 프로세스)

**비기능 요구사항 매핑**:
- NFR-001 성능: WebSocket 데이터 전달 500ms 이내, API p95 500ms
- NFR-005 사용성: 다양한 차트, 대시보드

---

### FUNC-007: 계량 실적 처리

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-007 |
| **기능명** | 계량 실적 처리 |
| **PRD 매핑** | FR-004, FR-005 |
| **모듈** | 스마트 계량 웹 관리 시스템 / 계량 CS 프로그램 |
| **우선순위** | HIGH |

**기능 설명**: 계량 시작/완료/재계량 프로세스를 처리하고 실적을 저장한다. 1차/2차/3차 계량과 공차/적재 중량을 관리한다.

**선행 조건 (Preconditions)**:
- 배차 매칭 완료 (자동 또는 수동)
- 인디게이터 안정화 중량값 수신

**후행 조건 (Postconditions)**:
- tb_weighing 레코드 생성/업데이트
- 전자 계량표 생성 (계량 완료 시)
- Push 알림 발송

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| dispatch_id | bigint | Y | 유효한 배차 ID |
| scale_id | bigint | Y | 유효한 계량대 ID |
| weighing_mode | varchar(20) | Y | LPR_AUTO / MOBILE_OTP / MANUAL / RE_WEIGH |
| weighing_type | varchar(20) | Y | FIRST / SECOND / THIRD |
| weight_value | decimal(10,2) | Y | 중량값 (kg), > 0 |
| lpr_plate_number | varchar(20) | N | LPR 인식 차량번호 |
| ai_confidence | decimal(5,4) | N | AI 신뢰도 (0.0~1.0) |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| weighing_id | bigint | 계량 실적 ID |
| gross_weight | decimal(10,2) | 총 중량 (kg) |
| tare_weight | decimal(10,2) | 차량 자체 중량 (kg) |
| net_weight | decimal(10,2) | 순 중량 = gross - tare |
| status | string | IN_PROGRESS / COMPLETED / RE_WEIGHING / ERROR |

**비즈니스 규칙**:
- BR-007-1: weighing_step 흐름: GROSS(공차) → TARE(적재) → COMPLETE
- BR-007-2: net_weight = gross_weight - tare_weight (자동 계산)
- BR-007-3: net_weight < 0 → 에러 (공차/적재 순서 확인)
- BR-007-4: 재계량(RE_WEIGH) 시 기존 계량 status를 RE_WEIGHING으로 변경, 새 계량 레코드 생성
- BR-007-5: 계량 완료 시 자동으로 전자 계량표 생성 (tb_weighing_slip INSERT)
- BR-007-6: 계량 완료 시 Push 알림 + 알림톡 발송
- BR-007-7: 안정화 중량값만 저장 (인디게이터 안정화 판단)

**정상 흐름 (Main Flow)**:
1. 차량이 계량대 위에 정위치 (차량검지기 확인)
2. 인디게이터에서 중량값 안정화 감지
3. 안정화 중량값을 CS 프로그램이 수신
4. CS 프로그램이 POST /api/v1/weighings 호출 (계량 시작)
5. 1차 계량(GROSS) 완료 → 중량값 저장
6. 차량 이동 후 2차 계량(TARE) 진행
7. 순 중량(net_weight) 자동 계산
8. 계량 완료(COMPLETE) → PUT /api/v1/weighings/{id}/complete
9. 전자 계량표 자동 생성
10. Push 알림 발송

**대안 흐름 (Alternative Flow)**:
- AF-007-1: 3차 계량 필요 시 → THIRD 타입으로 추가 계량
- AF-007-2: 재계량 → PUT /api/v1/weighings/{id}/re-weigh → 기존 건 RE_WEIGHING 처리, 새 건 생성
- AF-007-3: 수동 계량 모드 → 담당자가 터치스크린에서 직접 중량값 입력

**예외 흐름 (Exception Flow)**:
- EF-007-1: 인디게이터 통신 끊김 → CS 화면 경고, 수동 입력 전환
- EF-007-2: API 서버 통신 실패 → 로컬 캐싱, 복구 시 자동 동기화
- EF-007-3: net_weight < 0 → "공차/적재 순서를 확인하세요" 경고

**연관 기능**: FUNC-003 (배차 매칭), FUNC-009 (전자 계량표), FUNC-010 (인디게이터 연동)

**비기능 요구사항 매핑**:
- NFR-001 성능: 계량 데이터 실시간 동기화 5초 이내
- NFR-004 가용성: 네트워크 장애 시 로컬 캐싱 후 동기화

---

### FUNC-008: 기준정보 관리

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-008 |
| **기능명** | 기준정보 관리 |
| **PRD 매핑** | FR-004 |
| **모듈** | 스마트 계량 웹 관리 시스템 |
| **우선순위** | HIGH |

**기능 설명**: 운송사, 차량, 계량대, 공통코드 등 시스템 기준정보를 관리한다.

**선행 조건 (Preconditions)**:
- 사용자 로그인 (ADMIN 권한)

**후행 조건 (Postconditions)**:
- 기준정보 테이블 갱신
- Redis 캐시 갱신 (TTL 5분)

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| company_name | varchar(100) | Y | 운송사 등록 시 |
| company_type | varchar(20) | Y | 운송사 유형 |
| plate_number | varchar(20) | Y | 차량 등록 시, UNIQUE |
| vehicle_type | varchar(20) | Y | 차량 유형 |
| code_group | varchar(50) | Y | 공통코드 그룹 |
| code_value | varchar(50) | Y | 코드값 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| record_id | bigint | 생성/수정된 레코드 ID |
| operation | string | CREATE / UPDATE / DELETE |

**비즈니스 규칙**:
- BR-008-1: 기준정보 등록/수정/삭제는 ADMIN 권한만 가능
- BR-008-2: 차량번호(plate_number)는 시스템 전체에서 유일해야 함
- BR-008-3: 운송사 삭제 시 연관 배차가 없는 경우에만 가능 (또는 비활성화)
- BR-008-4: 기준정보 변경 시 Redis 캐시 무효화

**정상 흐름 (Main Flow)**:
1. 관리자가 기준정보 관리 화면 진입
2. 운송사/차량/계량대/공통코드 탭 선택
3. 목록 조회 (GET /api/v1/master/{type})
4. 등록/수정/삭제 작업 수행
5. 서버 처리 → Redis 캐시 갱신

**연관 기능**: FUNC-005 (배차 등록), FUNC-007 (계량 처리)

**비기능 요구사항 매핑**:
- NFR-001 성능: 기준정보 Redis 캐싱 (TTL 5분)
- NFR-003 확장성: 품목 유형 추가 시 공통코드로 관리

---

### FUNC-009: 전자 계량표 생성/조회

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-009 |
| **기능명** | 전자 계량표 생성/조회 |
| **PRD 매핑** | FR-006 |
| **모듈** | 스마트 계량 웹 관리 시스템 |
| **우선순위** | MEDIUM |

**기능 설명**: 계량 완료 시 전자 계량표를 자동 생성하고, 모바일/웹에서 조회 및 공유 기능을 제공한다.

**선행 조건 (Preconditions)**:
- 계량 실적 COMPLETED 상태

**후행 조건 (Postconditions)**:
- tb_weighing_slip 레코드 생성
- 계량표 번호 자동 채번

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| weighing_id | bigint | Y | 완료된 계량 실적 ID |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| slip_id | bigint | 계량표 ID |
| slip_number | varchar(30) | 자동 채번된 계량표 번호 (UNIQUE) |
| slip_data | jsonb | 계량표 상세 데이터 (차량, 품목, 중량, 일시 등) |

**비즈니스 규칙**:
- BR-009-1: 계량표 번호 자동 채번 규칙: YYYYMMDD-SEQ (예: 20260527-0001)
- BR-009-2: slip_data에 차량번호, 운송사, 품목, 총중량, 공차중량, 순중량, 계량일시 포함
- BR-009-3: 카카오톡 공유 시 카카오비즈 API 호출
- BR-009-4: SMS 공유 시 SMS Gateway 호출
- BR-009-5: 계량표 이력은 기간별 조회 가능

**정상 흐름 (Main Flow)**:
1. 계량 완료 이벤트 발생
2. 서버가 tb_weighing_slip에 계량표 레코드 생성
3. slip_number 자동 채번
4. slip_data에 계량 상세 정보 JSON 저장
5. 모바일 APP Push 알림 (계량표 생성 안내)
6. 사용자가 모바일/웹에서 계량표 조회

**대안 흐름 (Alternative Flow)**:
- AF-009-1: 카카오톡 공유 → POST /api/v1/slips/{id}/share {type: "KAKAO"}
- AF-009-2: SMS 공유 → POST /api/v1/slips/{id}/share {type: "SMS"}

**예외 흐름 (Exception Flow)**:
- EF-009-1: 카카오 API 장애 → SMS 대체 발송
- EF-009-2: SMS 발송 실패 → 재시도 큐 등록 (서킷브레이커)

**연관 기능**: FUNC-007 (계량 실적), FUNC-019 (모바일 전자 계량표 화면)

**비기능 요구사항 매핑**:
- NFR-002 보안: 계량표 데이터 무결성 보장
- NFR-004 가용성: 외부 서비스 장애 시 대체 채널 사용

---

### FUNC-030: 출문 관리

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-030 |
| **기능명** | 출문 관리 |
| **PRD 매핑** | FR-004 |
| **모듈** | 스마트 계량 웹 관리 시스템 |
| **우선순위** | MEDIUM |

**기능 설명**: 계량 완료 차량의 출문 처리를 관리한다.

**선행 조건 (Preconditions)**:
- 계량 실적 COMPLETED 상태
- MANAGER 이상 권한

**후행 조건 (Postconditions)**:
- tb_gate_pass 레코드 생성/업데이트

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| weighing_id | bigint | Y | 완료된 계량 실적 |
| dispatch_id | bigint | Y | 배차 ID |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| gate_pass_id | bigint | 출문 ID |
| pass_status | string | PENDING / PASSED / REJECTED |
| passed_at | timestamptz | 출문 시각 |

**비즈니스 규칙**:
- BR-030-1: 계량 완료 건만 출문 처리 가능
- BR-030-2: 출문 처리 시 pass_status를 PASSED로 변경
- BR-030-3: 출문 이력 조회 가능

**정상 흐름 (Main Flow)**:
1. 담당자가 출문관리 화면에서 출문 대기 목록 확인
2. 계량 완료 건 선택 → "출문 처리" 클릭
3. POST /api/v1/gate-passes 호출
4. 출문 상태 PASSED로 변경, passed_at 기록

**연관 기능**: FUNC-007 (계량 실적), FUNC-005 (배차 관리)

---

## 4. 모듈 3: 계량 CS 프로그램

### FUNC-010: 인디게이터 중량값 수신

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-010 |
| **기능명** | 인디게이터 중량값 수신 |
| **PRD 매핑** | FR-005 |
| **모듈** | 계량 CS 프로그램 |
| **우선순위** | HIGH |

**기능 설명**: 인디게이터로부터 RS-232C 시리얼 통신으로 중량값을 실시간 수신하고 안정화 판단을 수행한다.

**선행 조건 (Preconditions)**:
- 인디게이터 RS-232C 연결 완료
- COM 포트 설정 완료

**후행 조건 (Postconditions)**:
- 안정화 중량값 확정
- 계량 프로세스에 중량값 전달

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| serial_data | byte[] | Y | RS-232C 수신 데이터 |
| com_port | string | Y | COM1~COM9 |
| baud_rate | int | Y | 9600/19200/38400 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| weight_value | decimal(10,2) | 현재 중량값 (kg) |
| is_stable | boolean | 안정화 여부 |
| stable_weight | decimal(10,2) | 안정화 확정 중량값 |

**비즈니스 규칙**:
- BR-010-1: 안정화 판단: 연속 N회(설정값) 동일 중량 → 안정화
- BR-010-2: 중량값 변동 허용 범위: +/- 설정값 (kg)
- BR-010-3: 통신 타임아웃: 5초 이상 미수신 시 경고
- BR-010-4: 음수 중량 → 에러 처리

**정상 흐름 (Main Flow)**:
1. CS 프로그램이 System.IO.Ports로 COM 포트 오픈
2. 인디게이터에서 주기적으로 중량 데이터 수신 (100ms~1초)
3. 데이터 파싱 → 중량값 추출
4. 안정화 판단 로직 수행
5. 안정화 확정 → stable_weight를 계량 프로세스에 전달
6. CS 메인 화면에 현재 중량값 실시간 표시

**예외 흐름 (Exception Flow)**:
- EF-010-1: COM 포트 연결 실패 → 재연결 시도 (3회), 실패 시 관리자 알림
- EF-010-2: 데이터 파싱 오류 → 해당 패킷 폐기, 로그 기록
- EF-010-3: 5초 이상 미수신 → "인디게이터 통신 이상" 경고 표시

**연관 기능**: FUNC-007 (계량 실적), FUNC-011 (LPR 자동 계량 프로세스)

**비기능 요구사항 매핑**:
- NFR-001 성능: 중량값 실시간 수신 및 표시
- NFR-004 가용성: 통신 재시도 로직, 타임아웃 관리

---

### FUNC-011: LPR 자동 계량 프로세스

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-011 |
| **기능명** | LPR 자동 계량 프로세스 |
| **PRD 매핑** | FR-005 |
| **모듈** | 계량 CS 프로그램 |
| **우선순위** | HIGH |

**기능 설명**: LiDAR 감지 → LPR 촬영 → AI 검증 → 배차 매칭 → 자동 계량의 전체 자동 프로세스를 CS 프로그램에서 제어한다.

**선행 조건 (Preconditions)**:
- 모든 H/W 장비 정상 연결 (LPR, 센서, 인디게이터, 전광판, 차단기)
- API 서버 연결 상태

**후행 조건 (Postconditions)**:
- 계량 실적 저장
- 전자 계량표 생성
- 차단기 개방

**비즈니스 규칙**:
- BR-011-1: 자동 계량은 AI confidence >= 0.90 AND 단일 배차 매칭 시에만 진행
- BR-011-2: 전체 프로세스(센서감지 → 계량완료) 목표 시간: 차량 정차 후 30초 이내
- BR-011-3: 무인 자동 계량 비율 목표: 90% 이상

**정상 흐름 (Main Flow)**:
1. LiDAR/레이더 센서 → 차량 진입 감지
2. LPR 카메라 → 차량번호 촬영
3. API 서버 → AI 검증 요청
4. AI 결과 수신 (confidence >= 0.90)
5. 배차 자동 매칭 (단일 배차)
6. 차량검지기 → 정위치 확인
7. 인디게이터 → 안정화 중량값 수신
8. 계량 실적 저장 (POST /api/v1/weighings)
9. 전광판 → "계량 완료" 표시
10. 차단기 → 개방
11. 전자 계량표 자동 생성

**대안 흐름 (Alternative Flow)**:
- AF-011-1: AI confidence < 0.90 → OTP 프로세스 전환 (FUNC-004)
- AF-011-2: 다중 배차 → 전광판에 "모바일 배차 선택" 안내
- AF-011-3: 차량 미등록 → 수동 계량 모드 전환

**예외 흐름 (Exception Flow)**:
- EF-011-1: H/W 장비 장애 → 수동 계량 모드 전환 (터치스크린)
- EF-011-2: API 서버 통신 실패 → 로컬 캐싱 모드
- EF-011-3: 인디게이터 미안정화 (60초 초과) → "안정화 대기" 표시, 타임아웃 경고

**연관 기능**: FUNC-001~004, FUNC-007, FUNC-010, FUNC-012~013

**비기능 요구사항 매핑**:
- NFR-001 성능: E2E 3초 이내 (LPR → AI 검증)
- NFR-004 가용성: H/W 장애 시 수동 모드 전환 가능

---

### FUNC-012: 전광판 제어

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-012 |
| **기능명** | 전광판 제어 |
| **PRD 매핑** | FR-002, FR-005 |
| **모듈** | 계량 CS 프로그램 |
| **우선순위** | HIGH |

**기능 설명**: 계량대 전광판에 OTP 번호, 안내 메시지, 계량 상태를 표시한다.

**선행 조건 (Preconditions)**:
- 전광판 TCP/RS-485 연결 정상

**후행 조건 (Postconditions)**:
- 전광판에 메시지 표시

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| display_type | string | Y | OTP / STATUS / MESSAGE / ERROR |
| content | string | Y | 표시할 내용 |
| scale_id | bigint | Y | 계량대 식별자 |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| display_result | boolean | 표시 성공 여부 |

**비즈니스 규칙**:
- BR-012-1: 전광판 사양: 3단6열 특주사양 대형 전광판
- BR-012-2: OTP 표시 시 대형 폰트로 6자리 숫자 표시
- BR-012-3: 상태 메시지: "계량 대기", "계량 중", "계량 완료", "모바일 인증 필요"
- BR-012-4: 에러 메시지: "미등록 차량", "시스템 점검 중"

**정상 흐름 (Main Flow)**:
1. CS 프로그램이 계량 상태 변경 감지
2. display_type에 따라 전광판 표시 명령 생성
3. TCP/RS-485로 전광판에 명령 전송
4. 전광판에 메시지 표시

**연관 기능**: FUNC-004 (OTP 보안 계량), FUNC-011 (자동 계량)

---

### FUNC-013: 자동 차단기 제어

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-013 |
| **기능명** | 자동 차단기 제어 |
| **PRD 매핑** | FR-005 |
| **모듈** | 계량 CS 프로그램 |
| **우선순위** | HIGH |

**기능 설명**: 계량 프로세스에 따라 자동 차단기를 개폐 제어한다.

**선행 조건 (Preconditions)**:
- 차단기 연결 정상 (TCP/RS-485)
- 수동 스위치 연결

**후행 조건 (Postconditions)**:
- 차단기 상태 변경 (개방/차단)

**비즈니스 규칙**:
- BR-013-1: 계량 완료 시 자동 개방
- BR-013-2: 수동 스위치로 비상 개방 가능
- BR-013-3: 차단기 사양: 3M LED 사각바
- BR-013-4: 안전 우선: 차단기 동작 전 차량 정위치 확인

**정상 흐름 (Main Flow)**:
1. 계량 완료 신호 수신
2. 차량검지기로 차량 위치 확인
3. 차단기 개방 명령 전송
4. 차량 통과 확인
5. 차단기 차단 명령 전송

**예외 흐름 (Exception Flow)**:
- EF-013-1: 차단기 동작 실패 → 수동 스위치 사용 안내
- EF-013-2: 차량 검지 오류 → 차단기 유지, 관리자 호출

**연관 기능**: FUNC-011 (자동 계량), FUNC-014 (수동 계량)

---

### FUNC-014: 수동 계량 모드

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-014 |
| **기능명** | 수동 계량 모드 |
| **PRD 매핑** | FR-005 |
| **모듈** | 계량 CS 프로그램 |
| **우선순위** | HIGH |

**기능 설명**: LPR/모바일 계량이 불가한 경우 기존 터치스크린 방식으로 수동 계량을 수행한다.

**선행 조건 (Preconditions)**:
- 계량대 CS 프로그램 실행 중
- 인디게이터 정상 연결

**후행 조건 (Postconditions)**:
- 계량 실적 저장 (weighing_mode = MANUAL)

**비즈니스 규칙**:
- BR-014-1: 담당자가 터치스크린에서 차량번호, 배차 정보를 직접 선택/입력
- BR-014-2: 기존 RFID 방식 병행 운영 (전환 기간)
- BR-014-3: 수동 계량도 동일하게 전자 계량표 생성

**정상 흐름 (Main Flow)**:
1. 담당자가 CS 프로그램에서 "수동 계량" 모드 선택
2. 차량번호 입력 또는 목록에서 선택
3. 배차 정보 선택
4. 인디게이터 안정화 중량값 확인
5. "계량 확인" 버튼 클릭
6. 계량 실적 저장 (weighing_mode = MANUAL)

**연관 기능**: FUNC-010 (인디게이터), FUNC-007 (계량 실적)

---

### FUNC-015: 초기화/재계량

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-015 |
| **기능명** | 초기화/재계량 |
| **PRD 매핑** | FR-005 |
| **모듈** | 계량 CS 프로그램 |
| **우선순위** | HIGH |

**기능 설명**: 계량 오류 시 데이터 초기화 및 재계량을 수행한다.

**비즈니스 규칙**:
- BR-015-1: 재계량 시 기존 계량 건의 status를 RE_WEIGHING으로 변경
- BR-015-2: 새 계량 레코드를 RE_WEIGH 모드로 생성
- BR-015-3: 재계량 사유 기록 필수
- BR-015-4: 재계량 이력 추적 가능 (tb_weighing_log)

**정상 흐름 (Main Flow)**:
1. 담당자가 "재계량" 버튼 클릭
2. 재계량 사유 입력
3. 기존 계량 건 RE_WEIGHING 상태 변경
4. 새 계량 프로세스 시작
5. 재계량 완료 → 실적 저장
6. 재계량 이력 로그 기록

**연관 기능**: FUNC-007 (계량 실적), FUNC-010 (인디게이터)

---

### FUNC-016: 로컬 캐싱/오프라인 모드

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-016 |
| **기능명** | 로컬 캐싱/오프라인 모드 |
| **PRD 매핑** | FR-005 |
| **모듈** | 계량 CS 프로그램 |
| **우선순위** | MEDIUM |

**기능 설명**: API 서버와의 네트워크 연결이 끊긴 경우 로컬에 계량 데이터를 캐싱하고, 복구 시 자동 동기화한다.

**비즈니스 규칙**:
- BR-016-1: 네트워크 끊김 감지 → 자동으로 오프라인 모드 전환
- BR-016-2: 오프라인 중 계량 데이터는 로컬 SQLite/파일에 저장
- BR-016-3: 네트워크 복구 시 자동 동기화 (FIFO 순서)
- BR-016-4: 동기화 실패 건은 재시도 큐에 보관
- BR-016-5: 오프라인 모드 상태를 CS 화면에 명확히 표시

**연관 기능**: FUNC-011 (자동 계량), FUNC-014 (수동 계량)

**비기능 요구사항 매핑**:
- NFR-004 가용성: 네트워크 장애 시 로컬 캐싱, 복구 시 동기화 (RTO 1시간 이내)

---

## 5. 모듈 4: 계량관리 모바일 APP

### FUNC-017: 모바일 로그인

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-017 |
| **기능명** | 모바일 로그인 |
| **PRD 매핑** | FR-003 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | HIGH |

**기능 설명**: 담당자/운전자 구분 로그인, 안전 로그인(인증번호) 기능을 제공한다.

**선행 조건 (Preconditions)**:
- APP 설치 완료 (iOS/Android)
- 사용자 계정 등록 완료

**후행 조건 (Postconditions)**:
- JWT Access Token + Refresh Token 발급
- FCM 토큰 서버 등록

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| login_id | varchar(50) | Y | 등록된 로그인 ID |
| password | varchar(255) | Y | 비밀번호 |
| device_type | string | Y | MOBILE 고정 |

**비즈니스 규칙**:
- BR-017-1: 담당자(MANAGER) / 운전자(DRIVER) 역할 구분 로그인
- BR-017-2: 안전 로그인: 전화번호로 인증번호 발송 → 인증번호 입력
- BR-017-3: Access Token 30분, Refresh Token 7일
- BR-017-4: 로그인 성공 시 FCM 토큰 자동 등록
- BR-017-5: 비밀번호 5회 실패 시 계정 잠금

**정상 흐름 (Main Flow)**:
1. APP 실행 → 로그인 화면
2. 로그인 ID/비밀번호 입력
3. POST /api/v1/auth/login 호출
4. JWT 토큰 수신 → Hive 로컬 저장
5. FCM 토큰 등록 (POST /api/v1/notifications/push/register)
6. 역할에 따른 메인 화면 이동

**대안 흐름 (Alternative Flow)**:
- AF-017-1: 안전 로그인 → POST /api/v1/auth/login/otp (전화번호 + 인증번호)
- AF-017-2: 자동 로그인 → Refresh Token으로 Access Token 갱신

**연관 기능**: FUNC-018~021 (모바일 기능들)

**비기능 요구사항 매핑**:
- NFR-002 보안: JWT 인증, bcrypt 비밀번호, OTP 기반 안전 로그인
- NFR-005 사용성: Flutter iOS/Android 크로스 플랫폼

---

### FUNC-018: 배차 조회/선택

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-018 |
| **기능명** | 배차 조회/선택 |
| **PRD 매핑** | FR-003 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | HIGH |

**기능 설명**: 운전자가 배차지시 현황을 조회하고, 다중 배차 시 계량할 배차를 선택한다.

**비즈니스 규칙**:
- BR-018-1: 운전자 로그인 → 본인 차량의 당일 배차만 표시
- BR-018-2: 담당자 로그인 → 전체 배차 조회 가능
- BR-018-3: 다중 배차 시 목록에서 선택하여 계량 진행
- BR-018-4: 배차 상태별 색상 구분 (등록/진행중/완료)

**정상 흐름 (Main Flow)**:
1. 메인 화면 → "배차 조회" 탭
2. GET /api/v1/dispatches/my 호출 (운전자) 또는 GET /api/v1/dispatches (담당자)
3. 배차 목록 표시
4. 배차 선택 → 계량 진행 화면 이동

**연관 기능**: FUNC-019 (모바일 계량), FUNC-003 (배차 매칭)

---

### FUNC-019: 모바일 계량 진행

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-019 |
| **기능명** | 모바일 계량 진행 |
| **PRD 매핑** | FR-003 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | HIGH |

**기능 설명**: 모바일 APP에서 계량 진행 상태를 실시간으로 확인하고, OTP 기반 계량 시 모바일에서 계량을 제어한다.

**비즈니스 규칙**:
- BR-019-1: 계량 진행 상태 실시간 표시 (대기/계량중/완료)
- BR-019-2: OTP 계량 시 모바일에서 "계량 시작" 트리거 가능
- BR-019-3: 계량 완료 후 자동으로 전자 계량표 화면 이동

**연관 기능**: FUNC-004 (OTP 계량), FUNC-007 (계량 실적), FUNC-009 (전자 계량표)

---

### FUNC-020: 모바일 OTP 입력

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-020 |
| **기능명** | 모바일 OTP 입력 |
| **PRD 매핑** | FR-002, FR-003 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | HIGH |

**기능 설명**: 전광판에 표시된 OTP 번호를 모바일 APP에서 입력하여 본인 인증을 수행한다.

**비즈니스 규칙**:
- BR-020-1: 6자리 숫자 키패드 UI
- BR-020-2: OTP 잔여 시간 타이머 표시 (5분)
- BR-020-3: 검증 성공 → 배차 선택 → 계량 진행
- BR-020-4: 검증 실패 → 에러 메시지 + 재입력 안내

**정상 흐름 (Main Flow)**:
1. OTP 입력 화면 자동 또는 수동 진입
2. 전광판의 6자리 OTP 번호 입력
3. POST /api/v1/otp/verify 호출
4. 검증 성공 → 배차 매칭 → 계량 진행 화면

**연관 기능**: FUNC-004 (OTP 보안 계량), FUNC-018 (배차 선택)

---

### FUNC-021: 전자 계량표 조회/공유

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-021 |
| **기능명** | 전자 계량표 조회/공유 |
| **PRD 매핑** | FR-003, FR-006 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | HIGH |

**기능 설명**: 모바일 APP에서 전자 계량표를 조회하고 카카오톡/SMS로 공유한다.

**비즈니스 규칙**:
- BR-021-1: 계량 완료 후 자동 계량표 화면 표시
- BR-021-2: 카카오톡 공유: 계량표 링크 + 요약 정보
- BR-021-3: SMS 공유: 계량표 요약 텍스트
- BR-021-4: 이력 조회: 월별/일별, 기간 설정 가능

**정상 흐름 (Main Flow)**:
1. 계량 완료 → 자동으로 전자 계량표 화면
2. 계량표 상세 정보 표시 (차량, 품목, 중량, 시간)
3. "공유" 버튼 → 카카오톡/SMS 선택
4. POST /api/v1/slips/{id}/share 호출
5. 외부 서비스로 공유 발송

**연관 기능**: FUNC-009 (전자 계량표 생성)

---

### FUNC-022: 배차/계량 실적 조회

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-022 |
| **기능명** | 배차/계량 실적 조회 |
| **PRD 매핑** | FR-003 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | MEDIUM |

**기능 설명**: 모바일 APP에서 배차/계량 완료 실적을 월별/일별로 조회한다.

**비즈니스 규칙**:
- BR-022-1: 운전자: 본인 실적만 조회
- BR-022-2: 기간 설정 가능 (시작일~종료일)
- BR-022-3: 월별/일별 탭 전환

**연관 기능**: FUNC-018 (배차 조회), FUNC-021 (계량표 조회)

---

### FUNC-023: 전달사항/문의통화

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-023 |
| **기능명** | 전달사항/문의통화 |
| **PRD 매핑** | FR-003, FR-007 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | MEDIUM |

**기능 설명**: 모바일 APP에서 전달사항을 확인하고, 문의유형별 통화 기능을 제공한다.

**비즈니스 규칙**:
- BR-023-1: 전달사항: 관리자가 등록한 공지/안내 표시
- BR-023-2: 문의통화: 문의유형 선택 → 담당 부서 자동 연결
- BR-023-3: 문의유형: 물류관제실, 자재창고 등

**정상 흐름 (Main Flow)**:
1. "전달사항" 탭 → 공지 목록 확인
2. "문의" 탭 → 문의유형 선택
3. 선택한 유형의 담당 부서 연락처 표시
4. "전화하기" 버튼 → 전화 연결

**연관 기능**: FUNC-025 (유선통화 이원화)

---

### FUNC-024: Push 알림 수신

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-024 |
| **기능명** | Push 알림 수신 |
| **PRD 매핑** | FR-003 |
| **모듈** | 계량관리 모바일 APP |
| **우선순위** | HIGH |

**기능 설명**: FCM 기반 Push 알림을 수신하여 계량 완료, 배차 변경 등을 실시간으로 안내한다.

**비즈니스 규칙**:
- BR-024-1: 알림 유형: 계량 완료, 배차 등록/변경, 시스템 공지
- BR-024-2: 알림 수신 시 APP 내 알림 목록에 추가 (tb_notification)
- BR-024-3: 미읽은 알림 뱃지 표시
- BR-024-4: 알림톡(카카오) 병행 발송

**정상 흐름 (Main Flow)**:
1. 서버에서 FCM Push 발송
2. APP에서 알림 수신
3. 알림 목록에 추가 + 뱃지 표시
4. 알림 클릭 → 해당 상세 화면 이동

**연관 기능**: FUNC-007 (계량 실적), FUNC-021 (전자 계량표)

**비기능 요구사항 매핑**:
- NFR-001 성능: Push 알림 지연 최소화 (FCM 고신뢰성 메시지)

---

## 6. 모듈 5: 모바일 API

### FUNC-025-API: 사용자/인증 API

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-025-API |
| **기능명** | 사용자/인증 API |
| **PRD 매핑** | FR-008 |
| **모듈** | 모바일 API |
| **우선순위** | HIGH |

**기능 설명**: 사용자 인증(로그인, OTP, 토큰 갱신), 사용자 정보 조회 API를 제공한다.

**API 엔드포인트**:

| Method | Path | 설명 |
|--------|------|------|
| POST | /api/v1/auth/login | ID/PW 로그인 |
| POST | /api/v1/auth/login/otp | OTP 기반 로그인 |
| POST | /api/v1/auth/refresh | Token 갱신 |
| POST | /api/v1/auth/logout | 로그아웃 |

**비즈니스 규칙**:
- BR-API-1: JWT Access Token 30분, Refresh Token 7일 (Redis 세션 관리)
- BR-API-2: RBAC 권한: ADMIN > MANAGER > DRIVER
- BR-API-3: API 응답 시간 2초 이내

**비기능 요구사항 매핑**:
- NFR-001 성능: API 응답 2초 이내
- NFR-002 보안: TLS 1.3, JWT, bcrypt

---

### FUNC-026-API: 배차 정보 API

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-026-API |
| **기능명** | 배차 정보 API |
| **PRD 매핑** | FR-008 |
| **모듈** | 모바일 API |
| **우선순위** | HIGH |

**API 엔드포인트**:

| Method | Path | 설명 |
|--------|------|------|
| GET | /api/v1/dispatches | 배차 목록 조회 |
| POST | /api/v1/dispatches | 배차 등록 |
| GET | /api/v1/dispatches/{id} | 배차 상세 조회 |
| PUT | /api/v1/dispatches/{id} | 배차 수정 |
| DELETE | /api/v1/dispatches/{id} | 배차 삭제 |
| GET | /api/v1/dispatches/my | 내 배차 목록 |

---

### FUNC-027-API: 계량 처리 API

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-027-API |
| **기능명** | 계량 처리 API |
| **PRD 매핑** | FR-008 |
| **모듈** | 모바일 API |
| **우선순위** | HIGH |

**API 엔드포인트**:

| Method | Path | 설명 |
|--------|------|------|
| POST | /api/v1/weighings | 계량 시작 |
| PUT | /api/v1/weighings/{id}/complete | 계량 완료 |
| PUT | /api/v1/weighings/{id}/re-weigh | 재계량 |
| GET | /api/v1/weighings | 계량 실적 목록 |
| GET | /api/v1/weighings/{id} | 계량 상세 |
| GET | /api/v1/weighings/realtime | 실시간 현황 (WebSocket) |
| GET | /api/v1/weighings/statistics | 통계 |

---

### FUNC-028-API: Push 알림 API

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-028-API |
| **기능명** | Push 알림 API |
| **PRD 매핑** | FR-008 |
| **모듈** | 모바일 API |
| **우선순위** | HIGH |

**API 엔드포인트**:

| Method | Path | 설명 |
|--------|------|------|
| GET | /api/v1/notifications | 알림 목록 |
| PUT | /api/v1/notifications/{id}/read | 알림 읽음 |
| POST | /api/v1/notifications/push/register | FCM 토큰 등록 |

---

## 7. 모듈 6: H/W 인프라 연동

### FUNC-040: LPR 카메라 연동

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-040 |
| **기능명** | LPR 카메라 연동 |
| **PRD 매핑** | FR-001 |
| **모듈** | H/W 인프라 연동 |
| **우선순위** | HIGH |

**기능 설명**: LPR 카메라와 TCP/UDP 통신으로 차량번호 촬영 및 1차 인식 결과를 수신한다.

**통신 사양**:
- 프로토콜: TCP/UDP
- 연결 대상: 계량대 CS 프로그램
- 데이터: 촬영 이미지 + 1차 인식 차량번호

**연관 기능**: FUNC-001 (LPR 촬영), FUNC-011 (자동 계량)

---

### FUNC-041: LiDAR/레이더 센서 연동

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-041 |
| **기능명** | LiDAR/레이더 센서 연동 |
| **PRD 매핑** | FR-001 |
| **모듈** | H/W 인프라 연동 |
| **우선순위** | HIGH |

**기능 설명**: LiDAR/레이더 센서로 차량 진입을 감지하고 LPR 촬영을 트리거한다.

**통신 사양**:
- 프로토콜: TCP/UDP
- 이벤트: 차량 진입 감지 신호

**연관 기능**: FUNC-001 (LPR 촬영), FUNC-011 (자동 계량)

---

### FUNC-042: 차량검지기 연동

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-042 |
| **기능명** | 차량검지기 연동 |
| **PRD 매핑** | FR-005 |
| **모듈** | H/W 인프라 연동 |
| **우선순위** | HIGH |

**기능 설명**: 센서형 차량검지기로 계량대 위 차량 정위치를 확인한다.

**통신 사양**:
- 타입: 센서형
- 이벤트: 차량 존재/미존재 신호

**연관 기능**: FUNC-007 (계량 실적), FUNC-011 (자동 계량)

---

### FUNC-043: 인터폰 연동

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-043 |
| **기능명** | 인터폰 연동 |
| **PRD 매핑** | FR-007 |
| **모듈** | H/W 인프라 연동 |
| **우선순위** | MEDIUM |

**기능 설명**: 인터폰 자기/모기 각 1대를 설치하여 계량대와 관리실 간 통화를 지원한다.

**연관 기능**: FUNC-025 (유선통화 이원화)

---

## 8. 모듈 7: 유선통화 이원화 시스템

### FUNC-025: 유선통화 이원화

| 항목 | 내용 |
|------|------|
| **기능 ID** | FUNC-025 |
| **기능명** | 유선통화 이원화 |
| **PRD 매핑** | FR-007 |
| **모듈** | 유선통화 이원화 시스템 |
| **우선순위** | MEDIUM |

**기능 설명**: 기존 특정 부서 전화 문의 집중 문제를 해결하기 위해 문의유형별로 적절한 담당 부서로 통화를 이원화한다.

**선행 조건 (Preconditions)**:
- 인터폰 설치 완료
- 문의유형별 연락처 기준정보 등록

**후행 조건 (Postconditions)**:
- 통화 이력 기록 (tb_inquiry_call)

**입력 데이터**:

| 필드명 | 타입 | 필수 | 검증규칙 |
|--------|------|------|----------|
| inquiry_type | string | Y | 문의유형 (계량이상/배차문의/출문문의 등) |
| target_dept | string | Y | 대상부서 (물류관제실/자재창고 등) |

**출력 데이터**:

| 필드명 | 타입 | 설명 |
|--------|------|------|
| call_id | bigint | 통화 이력 ID |
| target_phone | string | 연결 전화번호 |

**비즈니스 규칙**:
- BR-025-1: 문의유형에 따라 담당 부서 자동 매핑
- BR-025-2: 물류관제실: 계량 이상, 차량 진입 문의
- BR-025-3: 자재창고: 부재료/자재 관련 문의
- BR-025-4: 통화 이력 기록 (tb_inquiry_call)

**정상 흐름 (Main Flow)**:
1. 운전자가 모바일 APP 또는 인터폰에서 문의유형 선택
2. 유형에 따라 담당 부서 연락처 표시
3. 전화 연결
4. 통화 이력 기록 (POST /api/v1/inquiries/call-log)

**연관 기능**: FUNC-023 (모바일 문의통화), FUNC-043 (인터폰)

---

## 9. 요구사항 추적 매트릭스

### 9.1 FR-ID ↔ FUNC-ID 매핑표

| PRD FR-ID | FR 명칭 | FUNC-ID | FUNC 명칭 | 모듈 |
|-----------|---------|---------|-----------|------|
| FR-001 | LPR 차량번호 자동인식 | FUNC-001 | LPR 차량번호 자동 촬영 | M1: LPR |
| FR-001 | LPR 차량번호 자동인식 | FUNC-002 | AI 차량번호 검증 | M1: LPR |
| FR-001 | LPR 차량번호 자동인식 | FUNC-003 | 배차 자동 매칭 | M1: LPR |
| FR-001 | LPR 차량번호 자동인식 | FUNC-040 | LPR 카메라 연동 | M6: H/W |
| FR-001 | LPR 차량번호 자동인식 | FUNC-041 | LiDAR/레이더 센서 연동 | M6: H/W |
| FR-002 | 모바일 OTP 보안 계량 | FUNC-004 | OTP 보안 계량 | M1: LPR |
| FR-002 | 모바일 OTP 보안 계량 | FUNC-020 | 모바일 OTP 입력 | M4: 모바일 |
| FR-002 | 모바일 OTP 보안 계량 | FUNC-012 | 전광판 제어 | M3: CS |
| FR-003 | 계량관리 모바일 APP | FUNC-017 | 모바일 로그인 | M4: 모바일 |
| FR-003 | 계량관리 모바일 APP | FUNC-018 | 배차 조회/선택 | M4: 모바일 |
| FR-003 | 계량관리 모바일 APP | FUNC-019 | 모바일 계량 진행 | M4: 모바일 |
| FR-003 | 계량관리 모바일 APP | FUNC-021 | 전자 계량표 조회/공유 | M4: 모바일 |
| FR-003 | 계량관리 모바일 APP | FUNC-022 | 배차/계량 실적 조회 | M4: 모바일 |
| FR-003 | 계량관리 모바일 APP | FUNC-023 | 전달사항/문의통화 | M4: 모바일 |
| FR-003 | 계량관리 모바일 APP | FUNC-024 | Push 알림 수신 | M4: 모바일 |
| FR-004 | 계량 웹 관리 시스템 | FUNC-005 | 배차 등록/관리 | M2: 웹 |
| FR-004 | 계량 웹 관리 시스템 | FUNC-006 | 계량 현황 관리 | M2: 웹 |
| FR-004 | 계량 웹 관리 시스템 | FUNC-008 | 기준정보 관리 | M2: 웹 |
| FR-004 | 계량 웹 관리 시스템 | FUNC-030 | 출문 관리 | M2: 웹 |
| FR-005 | 계량대 CS 프로그램 | FUNC-010 | 인디게이터 중량값 수신 | M3: CS |
| FR-005 | 계량대 CS 프로그램 | FUNC-011 | LPR 자동 계량 프로세스 | M3: CS |
| FR-005 | 계량대 CS 프로그램 | FUNC-013 | 자동 차단기 제어 | M3: CS |
| FR-005 | 계량대 CS 프로그램 | FUNC-014 | 수동 계량 모드 | M3: CS |
| FR-005 | 계량대 CS 프로그램 | FUNC-015 | 초기화/재계량 | M3: CS |
| FR-005 | 계량대 CS 프로그램 | FUNC-016 | 로컬 캐싱/오프라인 모드 | M3: CS |
| FR-005 | 계량대 CS 프로그램 | FUNC-042 | 차량검지기 연동 | M6: H/W |
| FR-006 | 전자 계량표/Paperless | FUNC-009 | 전자 계량표 생성/조회 | M2: 웹 |
| FR-006 | 전자 계량표/Paperless | FUNC-021 | 전자 계량표 조회/공유 (모바일) | M4: 모바일 |
| FR-007 | 유선통화 이원화/문의 | FUNC-025 | 유선통화 이원화 | M7: 통화 |
| FR-007 | 유선통화 이원화/문의 | FUNC-023 | 전달사항/문의통화 (모바일) | M4: 모바일 |
| FR-007 | 유선통화 이원화/문의 | FUNC-043 | 인터폰 연동 | M6: H/W |
| FR-008 | 모바일 API | FUNC-025-API | 사용자/인증 API | M5: API |
| FR-008 | 모바일 API | FUNC-026-API | 배차 정보 API | M5: API |
| FR-008 | 모바일 API | FUNC-027-API | 계량 처리 API | M5: API |
| FR-008 | 모바일 API | FUNC-028-API | Push 알림 API | M5: API |

### 9.2 매핑 검증 결과

| PRD FR-ID | 기능 수 | 커버리지 | 상태 |
|-----------|---------|----------|------|
| FR-001 | 5개 | 100% | COVERED |
| FR-002 | 3개 | 100% | COVERED |
| FR-003 | 7개 | 100% | COVERED |
| FR-004 | 4개 | 100% | COVERED |
| FR-005 | 7개 | 100% | COVERED |
| FR-006 | 2개 | 100% | COVERED |
| FR-007 | 3개 | 100% | COVERED |
| FR-008 | 4개 | 100% | COVERED |

**총 35개 기능 명세가 8개 PRD 기능 요구사항을 100% 커버합니다.**

### 9.3 NFR 매핑 검증

| NFR-ID | NFR 명칭 | 관련 FUNC | 반영 상태 |
|--------|----------|-----------|----------|
| NFR-001 | 성능 | FUNC-001,002,003,004,006,007,010,024 | COVERED |
| NFR-002 | 보안 | FUNC-004,009,017,025-API | COVERED |
| NFR-003 | 확장성 | FUNC-003,008 | COVERED |
| NFR-004 | 가용성 | FUNC-001,007,010,011,016 | COVERED |
| NFR-005 | 사용성 | FUNC-005,006,017 | COVERED |

### 9.4 TRD 기술 제약사항 반영 확인

| 제약사항 | 반영 FUNC | 확인 |
|----------|-----------|------|
| Spring Boot 3.2 백엔드 | FUNC-025~028-API, FUNC-005~009 | OK |
| React 18 + Ant Design 웹 | FUNC-005,006,008,009,030 | OK |
| Flutter 3.x 모바일 | FUNC-017~024 | OK |
| C# .NET WinForms CS | FUNC-010~016 | OK |
| PostgreSQL 16 DB | 전체 데이터 CRUD 기능 | OK |
| Redis 7 캐시/OTP | FUNC-004,008,016 | OK |
| RS-232C 인디게이터 | FUNC-010 | OK |
| TCP/UDP LPR/센서 | FUNC-040,041,042 | OK |
| JWT 인증 | FUNC-017,025-API | OK |
| WebSocket 실시간 | FUNC-006 | OK |
| FCM Push 알림 | FUNC-024,028-API | OK |
| 카카오/SMS 연동 | FUNC-009,021 | OK |

---

*이 문서는 PRD-20260127-154446, TRD-20260127-155235, WBS-20260127-160043 기반으로 작성되었습니다.*
