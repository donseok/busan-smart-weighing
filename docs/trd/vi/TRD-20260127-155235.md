# TRD (Tài liệu Yêu cầu Kỹ thuật) Xây dựng Hệ thống Cân thông minh Busan

**Phiên bản**: 1.0
**Ngày tạo**: 2026-01-27
**PRD cơ sở**: PRD-20260127-154446
**Trạng thái**: Draft

---

## 1. Ngăn xếp Công nghệ (Technology Stack)

### 1.1 Frontend (Web)
| Phân loại | Công nghệ | Phiên bản | Lý do lựa chọn |
|-----------|-----------|-----------|-----------------|
| Framework | React | 18.x | Được chỉ định trong ràng buộc PRD; SPA dựa trên component phù hợp cho bảng điều khiển trạng thái cân thời gian thực |
| State Management | Zustand | 4.x | Quản lý trạng thái nhẹ, tương thích React 18, giảm boilerplate so với Redux |
| UI Library | Ant Design | 5.x | Bảng dữ liệu cấp doanh nghiệp (bộ lọc, sắp xếp, tổng phụ, cố định cột), tích hợp component biểu đồ |
| Chart Library | Apache ECharts | 5.x | Hỗ trợ đa dạng loại biểu đồ, trực quan hóa dữ liệu thời gian thực, cấu hình bảng điều khiển |
| HTTP Client | Axios | 1.x | Giao tiếp REST API, quản lý token xác thực dựa trên interceptor |
| Build Tool | Vite | 5.x | HMR nhanh, bản build production tối ưu, hỗ trợ chính thức React 18 |
| Language | TypeScript | 5.x | An toàn kiểu dữ liệu, cải thiện khả năng bảo trì cho dự án quy mô lớn |

### 1.2 Frontend (Ứng dụng Di động)
| Phân loại | Công nghệ | Phiên bản | Lý do lựa chọn |
|-----------|-----------|-----------|-----------------|
| Framework | Flutter | 3.x | Được chỉ định trong ràng buộc PRD; đa nền tảng iOS/Android, mã nguồn duy nhất |
| Language | Dart | 3.x | Ngôn ngữ chính thức của Flutter, hiệu suất biên dịch AOT |
| State Management | Riverpod | 2.x | Quản lý trạng thái an toàn kiểu, phiên bản cải tiến của Provider |
| Push Notification | Firebase Cloud Messaging (FCM) | - | Thông báo đẩy tích hợp Android/iOS, liên kết thông báo Kakao |
| Local Storage | Hive | 2.x | Cơ sở dữ liệu cục bộ nhẹ, bộ nhớ đệm ngoại tuyến |

### 1.3 Backend
| Phân loại | Công nghệ | Phiên bản | Lý do lựa chọn |
|-----------|-----------|-----------|-----------------|
| Language | Java | 17 LTS | Hỗ trợ mặc định Spring Boot 3.x, phiên bản hỗ trợ dài hạn, tiêu chuẩn doanh nghiệp |
| Framework | Spring Boot | 3.2.x | Được chỉ định trong ràng buộc PRD; ổn định cấp doanh nghiệp, tích hợp WEB/WAS |
| Security | Spring Security | 6.x | Xác thực JWT, quản lý quyền RBAC, tích hợp bảo mật OTP |
| ORM | Spring Data JPA + QueryDSL | 3.x / 5.x | Truy vấn động an toàn kiểu, hỗ trợ điều kiện tìm kiếm phức tạp |
| API Documentation | SpringDoc OpenAPI | 2.x | Tự động tạo Swagger UI, chuẩn hóa đặc tả API |
| Messaging | Spring WebSocket + STOMP | 6.x | Truyền dữ liệu cân thời gian thực, giám sát trạng thái phần cứng |
| Scheduling | Spring Scheduler + Quartz | 2.x | Lập lịch điều xe, xử lý hàng loạt gửi thông báo |

### 1.4 Chương trình CS Trạm cân
| Phân loại | Công nghệ | Phiên bản | Lý do lựa chọn |
|-----------|-----------|-----------|-----------------|
| IDE | Visual Studio 2022 Professional | 17.x | Được chỉ định trong ràng buộc PRD; môi trường phát triển C# |
| Language | C# | 11 (.NET 7+) | PC trạm cân chạy Windows, hỗ trợ giao tiếp nối tiếp |
| Framework | .NET WinForms / WPF | 7+ | Giao diện màn hình cảm ứng, tương thích với PC cân hiện có |
| Serial Comm | System.IO.Ports | - | Giao tiếp RS-232C với bộ hiển thị, nhận dữ liệu LPR/cảm biến |
| HTTP Client | HttpClient | - | Tích hợp REST API máy chủ cân |

### 1.5 Cơ sở Dữ liệu
| Phân loại | Công nghệ | Phiên bản | Lý do lựa chọn |
|-----------|-----------|-----------|-----------------|
| Primary DB | PostgreSQL | 16.x | Được chỉ định trong ràng buộc PRD; giao dịch ACID, hỗ trợ JSON, khả năng mở rộng |
| Cache | Redis | 7.x | Lưu trữ tạm thời OTP, bộ nhớ đệm phiên, trạng thái cân thời gian thực |
| Message Queue | Redis Streams | 7.x | Xử lý bất đồng bộ sự kiện cân, chuyển tiếp sự kiện từ phần cứng đến máy chủ |

### 1.6 Hạ tầng
| Phân loại | Công nghệ | Lý do lựa chọn |
|-----------|-----------|-----------------|
| Server OS | CentOS / Rocky Linux 9 | Tiêu chuẩn máy chủ on-premises doanh nghiệp, ổn định |
| WEB/WAS | Spring Boot Embedded Tomcat | Tích hợp sẵn trong Spring Boot, không cần WAS riêng |
| Reverse Proxy | Nginx | 1.24.x | Kết thúc SSL, cân bằng tải, phục vụ tệp tĩnh |
| Containerization | Docker + Docker Compose | Nhất quán môi trường phát triển/staging, đơn giản hóa triển khai |
| CI/CD | Jenkins / GitLab CI | Tiêu chuẩn CI/CD nội bộ, tự động hóa xây dựng/triển khai |
| Monitoring | Prometheus + Grafana | Chỉ số hệ thống/ứng dụng, cảnh báo, bảng điều khiển |
| Log Management | ELK Stack (Elasticsearch + Logstash + Kibana) | Log tập trung, tìm kiếm, trực quan hóa |
| VCS | Git (GitLab) | Quản lý phiên bản mã nguồn, đánh giá mã, quy trình MR |

---

## 2. Kiến trúc Hệ thống (System Architecture)

### 2.1 Kiến trúc tổng thể

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       Hiện trường Trạm cân Nhà máy Busan                        │
│                                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  LPR     │  │ LiDAR    │  │ Radar    │  │ Bộ phát  │  │ Bộ hiển  │          │
│  │ Camera   │  │ Cảm biến │  │ Cảm biến │  │ hiện xe  │  │ thị      │          │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘          │
│       │              │              │              │              │               │
│       └──────────────┴──────────────┴──────────────┴──────────────┘               │
│                                     │                                             │
│                          ┌──────────▼──────────┐                                  │
│                          │  Chương trình CS     │◄──── RS-232C (Bộ hiển thị)      │
│                          │  Trạm cân            │                                  │
│                          │  (C# / .NET)         │──── TCP/UDP (LPR/Cảm biến)      │
│                          │  - Cân tự động LPR   │                                  │
│                          │  - Cân di động       │                                  │
│                          │  - Cân thủ công      │                                  │
│                          └──────────┬──────────┘                                  │
│                                     │                                             │
│  ┌──────────┐  ┌──────────┐        │        ┌──────────┐                         │
│  │ Bảng     │  │ Thanh    │        │        │ Bộ đàm   │                         │
│  │ điện tử  │  │ chắn tự  │        │        │(Tự/Cơ sở)│                        │
│  │ (OTP)    │  │ động     │        │        │          │                         │
│  └──────────┘  └──────────┘        │        └──────────┘                         │
└─────────────────────────────────────┼─────────────────────────────────────────────┘
                                      │ HTTPS (REST API)
                                      │
┌─────────────────────────────────────┼─────────────────────────────────────────────┐
│                              Hạ tầng Máy chủ                                     │
│                                     │                                             │
│              ┌──────────────────────▼──────────────────────┐                      │
│              │              Nginx (Reverse Proxy)          │                      │
│              │      Kết thúc SSL / Cân bằng tải            │                      │
│              └──────────┬──────────────────┬───────────────┘                      │
│                         │                  │                                       │
│              ┌──────────▼─────┐  ┌────────▼────────┐                              │
│              │  Spring Boot   │  │  Spring Boot    │                              │
│              │  WEB/WAS #1    │  │  WEB/WAS #2     │                              │
│              │  (API Server)  │  │  (API Server)   │                              │
│              └──────┬─────────┘  └────────┬────────┘                              │
│                     │                      │                                       │
│              ┌──────▼──────────────────────▼────────┐                              │
│              │         Tầng Dịch vụ                  │                              │
│              │  - Dịch vụ quản lý cân               │                              │
│              │  - Dịch vụ quản lý điều xe           │                              │
│              │  - Dịch vụ người dùng/xác thực       │                              │
│              │  - Dịch vụ thông báo                  │                              │
│              │  - Dịch vụ liên kết nhận dạng xe AI  │                              │
│              └──────┬──────────────┬────────────────┘                              │
│                     │              │                                               │
│         ┌───────────▼──┐   ┌──────▼──────┐   ┌───────────┐                       │
│         │ PostgreSQL   │   │   Redis     │   │ Công cụ   │                       │
│         │ (Primary DB) │   │ (Cache/OTP/ │   │ nhận dạng │                       │
│         │              │   │  MQ/Session)│   │ AI        │                       │
│         │              │   │             │   │(Ngoài/Nội)│                       │
│         └──────────────┘   └─────────────┘   └───────────┘                       │
│                                                                                   │
│         ┌───────────────────────────────────────────┐                             │
│         │  Monitoring: Prometheus + Grafana          │                             │
│         │  Logging: ELK Stack                        │                             │
│         └───────────────────────────────────────────┘                             │
└───────────────────────────────────────────────────────────────────────────────────┘
                                      │
                           ┌──────────┼──────────┐
                           │          │          │
                    ┌──────▼──┐ ┌─────▼───┐ ┌───▼──────────┐
                    │ Trình   │ │ Ứng     │ │ Dịch vụ      │
                    │ duyệt   │ │ dụng    │ │ bên ngoài    │
                    │ Web     │ │ Di động │ │              │
                    │ (React) │ │(Flutter)│ │ - Kakao API  │
                    │         │ │         │ │ - Dịch vụ SMS│
                    │         │ │         │ │ - FCM/APNs   │
                    └─────────┘ └─────────┘ └──────────────┘
```

### 2.2 Mô tả Component
| Component | Vai trò | Công nghệ |
|-----------|---------|-----------|
| Chương trình CS Trạm cân | Tích hợp thiết bị phần cứng, nhận giá trị trọng lượng, xử lý cân LPR/di động/thủ công, điều khiển bảng điện tử/thanh chắn | C# .NET WinForms |
| Nginx Reverse Proxy | Kết thúc SSL, cân bằng tải, phục vụ tài nguyên tĩnh, proxy WebSocket | Nginx 1.24 |
| Spring Boot API Server | Cung cấp REST API, xử lý logic nghiệp vụ, xác thực/phân quyền, WebSocket | Spring Boot 3.2 |
| Công cụ nhận dạng xe AI | Trích xuất và xác minh biển số xe từ ảnh chụp LPR, tỷ lệ nhận dạng trên 95% | Giải pháp bên ngoài hoặc tự phát triển (chưa quyết định) |
| PostgreSQL DB | Lưu trữ vĩnh viễn dữ liệu cốt lõi bao gồm điều xe, hồ sơ cân, người dùng, dữ liệu chủ | PostgreSQL 16 |
| Redis | Lưu trữ tạm thời OTP (TTL), bộ nhớ đệm phiên, trạng thái cân thời gian thực, hàng đợi sự kiện MQ | Redis 7 |
| Ứng dụng Web React | Hệ thống web quản lý cân (đăng ký điều xe, quản lý cân, dữ liệu chủ, quản lý xuất cổng, bảng điều khiển) | React 18 + Ant Design |
| Ứng dụng Di động Flutter | Ứng dụng quản lý cân (đăng nhập, tra cứu điều xe, tiến trình cân, phiếu cân điện tử, OTP) | Flutter 3.x |
| FCM/APNs | Thông báo đẩy hoàn thành cân, gửi tin nhắn thông báo | Firebase Cloud Messaging |
| Kakao API / SMS | Chia sẻ phiếu cân điện tử, gửi tin nhắn thông báo | Kakao Biz API, SMS Gateway |

### 2.3 Phương thức Giao tiếp
| Từ | Đến | Giao thức | Mô tả |
|----|-----|-----------|-------|
| Thiết bị LPR/Cảm biến | CS Trạm cân | TCP/UDP | Truyền dữ liệu nhận dạng biển số, sự kiện phát hiện cảm biến |
| Bộ hiển thị | CS Trạm cân | RS-232C (Serial) | Nhận giá trị trọng lượng ổn định thời gian thực |
| CS Trạm cân | Bảng điện tử/Thanh chắn | TCP/RS-485 | Hiển thị OTP, lệnh điều khiển đóng/mở thanh chắn |
| CS Trạm cân | API Server | HTTPS (REST) | Truyền kết quả cân, tra cứu thông tin điều xe, xác thực |
| React Web | API Server | HTTPS (REST) | Đăng ký điều xe, quản lý cân, CRUD dữ liệu chủ |
| React Web | API Server | WSS (WebSocket) | Trạng thái cân thời gian thực, cập nhật bảng điều khiển |
| Ứng dụng Flutter | API Server | HTTPS (REST) | Tra cứu điều xe, cân di động, xác thực OTP, phiếu cân điện tử |
| API Server | PostgreSQL | TCP (5432) | Đọc/ghi dữ liệu, xử lý giao dịch |
| API Server | Redis | TCP (6379) | Lưu trữ/xác minh OTP, bộ nhớ đệm phiên, phát hành sự kiện |
| API Server | Công cụ AI | HTTPS (REST) | Truyền ảnh biển số xe, nhận kết quả nhận dạng |
| API Server | Kakao API | HTTPS (REST) | Gửi tin nhắn thông báo, chia sẻ phiếu cân |
| API Server | SMS Gateway | HTTPS (REST) | Gửi thông báo SMS |
| API Server | FCM | HTTPS | Gửi thông báo đẩy (Android/iOS) |

---

## 3. Thiết kế Cơ sở Dữ liệu (Database Design)

### 3.1 Sơ đồ Quan hệ Thực thể (ERD)

```
┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐
│     tb_user      │       │   tb_company     │       │   tb_vehicle     │
├──────────────────┤       ├──────────────────┤       ├──────────────────┤
│ user_id (PK)     │──┐    │ company_id (PK)  │──┐    │ vehicle_id (PK)  │
│ company_id (FK)  │──┘──▶ │ company_name     │  │    │ plate_number     │
│ user_name        │       │ company_type     │  │    │ company_id (FK)  │──▶
│ phone_number     │       │ contact_phone    │  │    │ vehicle_type     │
│ user_role        │       │ is_active        │  │    │ is_active        │
│ login_id         │       └──────────────────┘  │    └────────┬─────────┘
│ password_hash    │                              │             │
│ is_active        │                              │             │
└──────────────────┘                              │             │
        │                                         │             │
        │                                         │             │
        ▼                                         │             │
┌──────────────────┐       ┌──────────────────┐   │             │
│ tb_otp_session   │       │  tb_dispatch     │   │             │
├──────────────────┤       ├──────────────────┤   │             │
│ otp_id (PK)      │       │ dispatch_id (PK) │   │             │
│ user_id (FK)     │       │ vehicle_id (FK)  │───┘─────────────┘
│ otp_code         │       │ company_id (FK)  │───┘
│ vehicle_id (FK)  │       │ item_type        │
│ expires_at       │       │ item_name        │
│ is_verified      │       │ dispatch_date    │
│ created_at       │       │ dispatch_status  │
└──────────────────┘       │ created_by (FK)  │
                           │ created_at       │
                           └────────┬─────────┘
                                    │
                                    │ 1:N
                                    ▼
                           ┌──────────────────┐       ┌──────────────────┐
                           │ tb_weighing      │       │ tb_weighing_log  │
                           ├──────────────────┤       ├──────────────────┤
                           │ weighing_id (PK) │──────▶│ log_id (PK)      │
                           │ dispatch_id (FK) │       │ weighing_id (FK) │
                           │ vehicle_id (FK)  │       │ log_type         │
                           │ scale_id (FK)    │       │ log_message      │
                           │ weighing_type    │       │ created_at       │
                           │ weighing_step    │       └──────────────────┘
                           │ gross_weight     │
                           │ tare_weight      │       ┌──────────────────┐
                           │ net_weight       │       │ tb_weighing_slip │
                           │ weighing_mode    │       ├──────────────────┤
                           │ lpr_plate_number │──────▶│ slip_id (PK)     │
                           │ ai_confidence    │       │ weighing_id (FK) │
                           │ status           │       │ slip_number      │
                           │ weighed_at       │       │ slip_data (JSON) │
                           │ created_at       │       │ shared_via       │
                           └──────────────────┘       │ shared_at        │
                                    │                 │ created_at       │
                                    │                 └──────────────────┘
                                    │
                           ┌────────▼─────────┐       ┌──────────────────┐
                           │  tb_scale        │       │ tb_gate_pass     │
                           ├──────────────────┤       ├──────────────────┤
                           │ scale_id (PK)    │       │ gate_pass_id(PK) │
                           │ scale_name       │       │ weighing_id (FK) │
                           │ location         │       │ dispatch_id (FK) │
                           │ scale_type       │       │ pass_status      │
                           │ is_active        │       │ passed_at        │
                           └──────────────────┘       │ created_at       │
                                                      └──────────────────┘
┌──────────────────┐       ┌──────────────────┐
│ tb_master_code   │       │ tb_notification  │
├──────────────────┤       ├──────────────────┤
│ code_id (PK)     │       │ noti_id (PK)     │
│ code_group       │       │ user_id (FK)     │
│ code_value       │       │ noti_type        │
│ code_name        │       │ title            │
│ sort_order       │       │ message          │
│ is_active        │       │ is_read          │
│ parent_code_id   │       │ sent_at          │
└──────────────────┘       └──────────────────┘

┌──────────────────┐
│ tb_inquiry_call  │
├──────────────────┤
│ call_id (PK)     │
│ user_id (FK)     │
│ inquiry_type     │
│ target_dept      │
│ call_status      │
│ created_at       │
└──────────────────┘
```

### 3.2 Đặc tả Bảng

#### tb_user (Người dùng)
| Tên cột | Kiểu | NULL | Mặc định | Mô tả |
|---------|------|------|----------|-------|
| user_id | BIGSERIAL | NO | AUTO | PK |
| company_id | BIGINT | YES | NULL | FK tới tb_company, công ty vận tải trực thuộc |
| user_name | VARCHAR(50) | NO | - | Tên người dùng |
| phone_number | VARCHAR(20) | NO | - | Số điện thoại (dùng cho xác thực OTP di động) |
| user_role | VARCHAR(20) | NO | - | ADMIN, MANAGER, DRIVER |
| login_id | VARCHAR(50) | NO | - | ID đăng nhập |
| password_hash | VARCHAR(255) | NO | - | Mã băm mật khẩu (bcrypt) |
| is_active | BOOLEAN | NO | true | Trạng thái hoạt động |
| created_at | TIMESTAMPTZ | NO | NOW() | Thời gian tạo |
| updated_at | TIMESTAMPTZ | NO | NOW() | Thời gian cập nhật |

#### tb_vehicle (Xe)
| Tên cột | Kiểu | NULL | Mặc định | Mô tả |
|---------|------|------|----------|-------|
| vehicle_id | BIGSERIAL | NO | AUTO | PK |
| plate_number | VARCHAR(20) | NO | - | Biển số xe (cho khớp LPR), UNIQUE |
| company_id | BIGINT | YES | NULL | FK tới tb_company |
| vehicle_type | VARCHAR(20) | NO | - | Loại xe |
| max_load_weight | DECIMAL(10,2) | YES | NULL | Trọng lượng tải tối đa (kg) |
| is_active | BOOLEAN | NO | true | Trạng thái hoạt động |
| created_at | TIMESTAMPTZ | NO | NOW() | Thời gian tạo |

#### tb_dispatch (Điều xe)
| Tên cột | Kiểu | NULL | Mặc định | Mô tả |
|---------|------|------|----------|-------|
| dispatch_id | BIGSERIAL | NO | AUTO | PK |
| vehicle_id | BIGINT | NO | - | FK tới tb_vehicle |
| company_id | BIGINT | NO | - | FK tới tb_company |
| item_type | VARCHAR(20) | NO | - | Phụ phẩm, Chất thải, Phụ liệu, Xuất kho, Thông thường |
| item_name | VARCHAR(100) | NO | - | Tên hàng hóa |
| dispatch_date | DATE | NO | - | Ngày điều xe |
| dispatch_status | VARCHAR(20) | NO | REGISTERED | REGISTERED, IN_PROGRESS, COMPLETED, CANCELLED |
| origin_location | VARCHAR(100) | YES | NULL | Điểm xuất phát |
| destination | VARCHAR(100) | YES | NULL | Điểm đến |
| remarks | TEXT | YES | NULL | Ghi chú |
| created_by | BIGINT | NO | - | FK tới tb_user |
| created_at | TIMESTAMPTZ | NO | NOW() | Thời gian tạo |
| updated_at | TIMESTAMPTZ | NO | NOW() | Thời gian cập nhật |

#### tb_weighing (Hồ sơ cân)
| Tên cột | Kiểu | NULL | Mặc định | Mô tả |
|---------|------|------|----------|-------|
| weighing_id | BIGSERIAL | NO | AUTO | PK |
| dispatch_id | BIGINT | NO | - | FK tới tb_dispatch |
| vehicle_id | BIGINT | NO | - | FK tới tb_vehicle |
| scale_id | BIGINT | NO | - | FK tới tb_scale |
| weighing_type | VARCHAR(20) | NO | - | FIRST, SECOND, THIRD (Lần 1/Lần 2/Lần 3) |
| weighing_step | VARCHAR(20) | NO | - | GROSS, TARE, COMPLETE |
| gross_weight | DECIMAL(10,2) | YES | NULL | Tổng trọng lượng (kg) |
| tare_weight | DECIMAL(10,2) | YES | NULL | Trọng lượng xe rỗng (kg) |
| net_weight | DECIMAL(10,2) | YES | NULL | Trọng lượng tịnh (kg) = gross - tare |
| weighing_mode | VARCHAR(20) | NO | - | LPR_AUTO, MOBILE_OTP, MANUAL, RE_WEIGH |
| lpr_plate_number | VARCHAR(20) | YES | NULL | Biển số xe nhận dạng bởi LPR |
| ai_confidence | DECIMAL(5,4) | YES | NULL | Độ tin cậy nhận dạng biển số AI (0.0~1.0) |
| lpr_image_path | VARCHAR(500) | YES | NULL | Đường dẫn lưu trữ ảnh chụp LPR |
| status | VARCHAR(20) | NO | IN_PROGRESS | IN_PROGRESS, COMPLETED, RE_WEIGHING, ERROR |
| weighed_at | TIMESTAMPTZ | YES | NULL | Thời gian hoàn thành cân |
| created_at | TIMESTAMPTZ | NO | NOW() | Thời gian tạo |
| updated_at | TIMESTAMPTZ | NO | NOW() | Thời gian cập nhật |

#### tb_weighing_slip (Phiếu cân điện tử)
| Tên cột | Kiểu | NULL | Mặc định | Mô tả |
|---------|------|------|----------|-------|
| slip_id | BIGSERIAL | NO | AUTO | PK |
| weighing_id | BIGINT | NO | - | FK tới tb_weighing |
| slip_number | VARCHAR(30) | NO | - | Số phiếu cân (tạo tự động), UNIQUE |
| slip_data | JSONB | NO | - | Dữ liệu chi tiết phiếu cân (JSON) |
| shared_via | VARCHAR(20) | YES | NULL | KAKAO, SMS, NONE |
| shared_at | TIMESTAMPTZ | YES | NULL | Thời gian chia sẻ |
| created_at | TIMESTAMPTZ | NO | NOW() | Thời gian tạo |

#### tb_otp_session (Phiên OTP)
| Tên cột | Kiểu | NULL | Mặc định | Mô tả |
|---------|------|------|----------|-------|
| otp_id | BIGSERIAL | NO | AUTO | PK |
| user_id | BIGINT | YES | NULL | FK tới tb_user |
| otp_code | VARCHAR(6) | NO | - | Mã OTP 6 chữ số |
| vehicle_id | BIGINT | YES | NULL | FK tới tb_vehicle |
| phone_number | VARCHAR(20) | NO | - | Số điện thoại xác thực |
| expires_at | TIMESTAMPTZ | NO | - | Thời gian hết hạn (5 phút sau khi tạo) |
| is_verified | BOOLEAN | NO | false | Trạng thái xác minh hoàn thành |
| created_at | TIMESTAMPTZ | NO | NOW() | Thời gian tạo |

#### tb_scale (Trạm cân)
| Tên cột | Kiểu | NULL | Mặc định | Mô tả |
|---------|------|------|----------|-------|
| scale_id | BIGSERIAL | NO | AUTO | PK |
| scale_name | VARCHAR(50) | NO | - | Tên trạm cân |
| location | VARCHAR(100) | NO | - | Vị trí lắp đặt |
| scale_type | VARCHAR(20) | NO | - | SMART, MANUAL |
| max_capacity | DECIMAL(10,2) | YES | NULL | Sức chứa tối đa (kg) |
| is_active | BOOLEAN | NO | true | Trạng thái hoạt động |
| last_calibrated_at | TIMESTAMPTZ | YES | NULL | Thời gian hiệu chuẩn gần nhất |

### 3.3 Chiến lược Chỉ mục
| Bảng | Tên chỉ mục | Cột | Loại | Mục đích |
|------|-------------|-----|------|----------|
| tb_vehicle | idx_vehicle_plate | plate_number | B-Tree UNIQUE | Khớp biển số LPR (truy vấn quan trọng) |
| tb_dispatch | idx_dispatch_date_status | dispatch_date, dispatch_status | B-Tree | Truy vấn tình trạng điều xe theo ngày |
| tb_dispatch | idx_dispatch_vehicle | vehicle_id | B-Tree | Lịch sử điều xe theo xe |
| tb_dispatch | idx_dispatch_company | company_id | B-Tree | Truy vấn điều xe theo công ty vận tải |
| tb_weighing | idx_weighing_dispatch | dispatch_id | B-Tree | Hồ sơ cân theo điều xe |
| tb_weighing | idx_weighing_vehicle | vehicle_id | B-Tree | Lịch sử cân theo xe |
| tb_weighing | idx_weighing_date | weighed_at | B-Tree | Truy vấn kết quả theo khoảng thời gian |
| tb_weighing | idx_weighing_status | status | B-Tree | Lọc theo trạng thái |
| tb_weighing | idx_weighing_mode | weighing_mode | B-Tree | Thống kê theo phương thức cân |
| tb_weighing_slip | idx_slip_number | slip_number | B-Tree UNIQUE | Tìm kiếm số phiếu cân |
| tb_otp_session | idx_otp_code_expires | otp_code, expires_at | B-Tree | Xác minh mã OTP |
| tb_otp_session | idx_otp_phone | phone_number | B-Tree | Tra cứu OTP theo số điện thoại |
| tb_user | idx_user_login | login_id | B-Tree UNIQUE | Tra cứu ID đăng nhập |
| tb_user | idx_user_phone | phone_number | B-Tree | Tra cứu người dùng theo số điện thoại |
| tb_notification | idx_noti_user_read | user_id, is_read | B-Tree | Thông báo chưa đọc theo người dùng |

---

## 4. Đặc tả API (API Specification)

### 4.1 Thông tin chung
- Base URL: `/api/v1`
- Xác thực: Bearer Token (JWT) - Access Token (30 phút) + Refresh Token (7 ngày)
- Định dạng phản hồi: JSON (application/json)
- Cấu trúc phản hồi chung:

```json
{
  "success": true,
  "data": { ... },
  "message": "Thành công",
  "timestamp": "2026-01-27T15:00:00+09:00"
}
```

- Phản hồi lỗi chung:

```json
{
  "success": false,
  "error": {
    "code": "ERR_001",
    "message": "Mô tả lỗi"
  },
  "timestamp": "2026-01-27T15:00:00+09:00"
}
```

### 4.2 API Xác thực

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| POST | /auth/login | Đăng nhập (ID/PW) | Không yêu cầu |
| POST | /auth/login/otp | Đăng nhập bằng OTP (di động) | Không yêu cầu |
| POST | /auth/refresh | Gia hạn Access Token | Refresh Token |
| POST | /auth/logout | Đăng xuất | Yêu cầu |

##### POST /auth/login
**Request**:
```json
{
  "login_id": "string",
  "password": "string",
  "device_type": "WEB | MOBILE"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "access_token": "jwt_token",
    "refresh_token": "refresh_token",
    "user": {
      "user_id": 1,
      "user_name": "Hong Gildong",
      "user_role": "DRIVER",
      "company_name": "ABC Transport"
    },
    "expires_in": 1800
  }
}
```

### 4.3 API Quản lý Điều xe

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| GET | /dispatches | Truy vấn danh sách điều xe | Yêu cầu |
| POST | /dispatches | Đăng ký điều xe | Yêu cầu (ADMIN, MANAGER) |
| GET | /dispatches/{id} | Truy vấn chi tiết điều xe | Yêu cầu |
| PUT | /dispatches/{id} | Cập nhật điều xe | Yêu cầu (ADMIN, MANAGER) |
| DELETE | /dispatches/{id} | Xóa điều xe | Yêu cầu (ADMIN) |
| GET | /dispatches/my | Danh sách điều xe của tôi (tài xế) | Yêu cầu (DRIVER) |

##### GET /dispatches
**Query Parameters**:
- `dispatch_date` (date, tùy chọn): Bộ lọc ngày điều xe
- `item_type` (string, tùy chọn): Bộ lọc loại hàng hóa
- `status` (string, tùy chọn): Bộ lọc trạng thái
- `company_id` (integer, tùy chọn): Bộ lọc công ty vận tải
- `page` (integer, mặc định: 1): Số trang
- `size` (integer, mặc định: 20): Kích thước trang

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "dispatch_id": 1,
        "vehicle_plate": "12ga3456",
        "company_name": "ABC Transport",
        "item_type": "Phụ phẩm",
        "item_name": "Xỉ",
        "dispatch_date": "2026-01-27",
        "dispatch_status": "REGISTERED"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total_count": 150,
      "total_pages": 8
    }
  }
}
```

### 4.4 API Quản lý Cân

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| POST | /weighings | Bắt đầu cân (LPR tự động/di động/thủ công) | Yêu cầu |
| PUT | /weighings/{id}/complete | Xử lý hoàn thành cân | Yêu cầu |
| PUT | /weighings/{id}/re-weigh | Xử lý cân lại | Yêu cầu |
| GET | /weighings | Truy vấn danh sách hồ sơ cân | Yêu cầu |
| GET | /weighings/{id} | Truy vấn chi tiết cân | Yêu cầu |
| GET | /weighings/realtime | Trạng thái cân thời gian thực (nâng cấp WebSocket) | Yêu cầu |
| GET | /weighings/statistics | Thống kê cân (theo ngày/tháng/hàng hóa) | Yêu cầu |

##### POST /weighings
**Request**:
```json
{
  "dispatch_id": 1,
  "scale_id": 1,
  "weighing_mode": "LPR_AUTO | MOBILE_OTP | MANUAL",
  "weighing_type": "FIRST | SECOND | THIRD",
  "weight_value": 15000.50,
  "lpr_plate_number": "12ga3456",
  "ai_confidence": 0.9823
}
```

### 4.5 API Xác thực OTP

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| POST | /otp/generate | Tạo OTP (hiển thị trên bảng điện tử) | Nội bộ |
| POST | /otp/verify | Xác minh OTP (nhập từ di động) | Không yêu cầu |

##### POST /otp/verify
**Request**:
```json
{
  "otp_code": "123456",
  "phone_number": "010-1234-5678"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "verified": true,
    "vehicle_id": 1,
    "plate_number": "12ga3456",
    "dispatch_id": 5
  }
}
```

### 4.6 API Phiếu cân Điện tử

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| GET | /slips/{weighing_id} | Tra cứu phiếu cân điện tử | Yêu cầu |
| POST | /slips/{slip_id}/share | Chia sẻ phiếu cân (KakaoTalk/SMS) | Yêu cầu |
| GET | /slips/history | Tra cứu lịch sử phiếu cân | Yêu cầu |

### 4.7 API Thông báo

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| GET | /notifications | Truy vấn danh sách thông báo | Yêu cầu |
| PUT | /notifications/{id}/read | Đánh dấu thông báo đã đọc | Yêu cầu |
| POST | /notifications/push/register | Đăng ký token FCM | Yêu cầu |

### 4.8 API Dữ liệu Chủ

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| GET | /master/companies | Danh sách công ty vận tải | Yêu cầu |
| GET | /master/vehicles | Danh sách xe | Yêu cầu |
| GET | /master/scales | Danh sách trạm cân | Yêu cầu |
| GET | /master/codes/{group} | Tra cứu mã chung | Yêu cầu |
| POST | /master/companies | Đăng ký công ty vận tải | Yêu cầu (ADMIN) |
| POST | /master/vehicles | Đăng ký xe | Yêu cầu (ADMIN) |

### 4.9 API Quản lý Xuất cổng

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| GET | /gate-passes | Truy vấn danh sách xuất cổng | Yêu cầu |
| POST | /gate-passes | Xử lý xuất cổng | Yêu cầu (MANAGER) |
| PUT | /gate-passes/{id} | Thay đổi trạng thái xuất cổng | Yêu cầu (MANAGER) |

### 4.10 API Hỏi đáp/Cuộc gọi

| Method | Endpoint | Mô tả | Xác thực |
|--------|----------|-------|----------|
| GET | /inquiries/contacts | Danh sách liên hệ theo loại hỏi đáp | Yêu cầu |
| POST | /inquiries/call-log | Ghi lại lịch sử cuộc gọi | Yêu cầu |

---

## 5. Yêu cầu Bảo mật (Security Requirements)

### 5.1 Xác thực/Phân quyền
| Hạng mục | Phương thức triển khai |
|----------|----------------------|
| Xác thực | JWT (Access Token 30 phút + Refresh Token 7 ngày) |
| Quản lý quyền | RBAC - ADMIN (Quản trị viên hệ thống), MANAGER (Nhân viên vận hành cân), DRIVER (Tài xế) |
| Quản lý phiên | Lưu trữ Refresh Token dựa trên Redis, giới hạn phiên đồng thời |
| Xác thực OTP | Mã 6 chữ số dựa trên TOTP, hiệu lực 5 phút, quản lý TTL trên Redis |
| Xác thực di động | Đăng nhập an toàn dựa trên số điện thoại + mã xác minh |

### 5.2 Bảo mật Dữ liệu
| Hạng mục | Phương thức triển khai |
|----------|----------------------|
| Mã hóa truyền tải | TLS 1.3 (kết thúc SSL trên Nginx) |
| Lưu trữ mật khẩu | bcrypt (cost factor 12) |
| Thông tin cá nhân | Che giấu số điện thoại, biển số xe (log, hiển thị màn hình) |
| Mã hóa DB | Mã hóa AES-256 các cột nhạy cảm (phone_number, v.v.) |
| Quản lý khóa API | Quản lý bí mật dựa trên Spring Vault hoặc biến môi trường |

### 5.3 Chính sách Bảo mật
- [x] Đối phó OWASP Top 10 (áp dụng mặc định Spring Security)
- [x] Phòng chống SQL Injection (JPA Parameterized Query)
- [x] Phòng chống XSS (React tự động escape + CSP headers)
- [x] Phòng chống CSRF (JWT Stateless, SameSite Cookie)
- [x] Rate Limiting (Nginx limit_req, áp dụng phân biệt theo API)
- [x] Chính sách CORS (danh sách Origin cho phép)
- [x] Xác minh đầu vào (Bean Validation, kiểm tra DTO)
- [x] Ghi nhật ký kiểm toán (ghi lại lịch sử thay đổi đăng nhập/cân/điều xe)

### 5.4 Bảo mật Mạng
| Hạng mục | Phương thức triển khai |
|----------|----------------------|
| Tường lửa | Chỉ cho phép các cổng cần thiết giữa các máy chủ (5432, 6379, 8080, 443) |
| VPN | Kết nối VPN mạng nội bộ giữa CS Trạm cân và máy chủ |
| Truy cập DB | Chỉ cho phép truy cập từ máy chủ ứng dụng |
| API bên ngoài | Cho phép outbound dựa trên danh sách trắng (Kakao, FCM) |

---

## 6. Yêu cầu Hiệu suất (Performance Requirements)

### 6.1 Thời gian Phản hồi
| Phân loại | Mục tiêu | Phương pháp đo |
|-----------|----------|----------------|
| Nhận dạng LPR đến hoàn thành cân tự động | < 3 giây (E2E) | Timestamp nhật ký ứng dụng |
| Phản hồi API (p50) | < 200ms | Prometheus + Spring Actuator |
| Phản hồi API (p95) | < 500ms | Prometheus + Spring Actuator |
| Phản hồi API (p99) | < 1.000ms | Prometheus + Spring Actuator |
| Tải trang Web (FCP) | < 2 giây | Lighthouse |
| Tải trang Web (LCP) | < 3 giây | Lighthouse |
| Chuyển màn hình ứng dụng di động | < 1 giây | Flutter DevTools |
| Truyền dữ liệu WebSocket | < 500ms | Nhật ký máy chủ |

### 6.2 Thông lượng
| Phân loại | Mục tiêu |
|-----------|----------|
| Người dùng Web đồng thời | Trên 50 |
| Người dùng di động đồng thời | Trên 200 |
| API TPS (bình thường) | 100 TPS |
| API TPS (cao điểm) | 300 TPS |
| Số lần cân xử lý hàng ngày | Trên 500 |

### 6.3 Chiến lược Tối ưu hóa
- [x] Bộ nhớ đệm Redis: Dữ liệu chủ, danh sách điều xe, thông tin xe (TTL 5 phút)
- [x] Database Connection Pooling: HikariCP (min: 10, max: 30)
- [x] Tối ưu truy vấn: Truy vấn động QueryDSL, phân trang, sử dụng chỉ mục
- [x] CDN tài nguyên tĩnh: Bộ nhớ đệm tệp tĩnh Nginx (JS/CSS/Image)
- [x] Nén phản hồi API: Gzip (Nginx)
- [x] Tải lười: Phân tách mã component React
- [x] DB Read Replica: Phân tán tải đọc (mở rộng trong tương lai)
- [x] Tối ưu hình ảnh: Thay đổi kích thước ảnh chụp LPR khi lưu trữ

---

## 7. Yêu cầu Hạ tầng (Infrastructure Requirements)

### 7.1 Cấu hình Máy chủ
| Môi trường | Cấu hình | Thông số | Mục đích |
|-----------|----------|----------|----------|
| Development | 1 VM | 4 vCPU, 16GB RAM, 200GB SSD | Môi trường phát triển/kiểm thử tích hợp |
| Staging | 2 VM | 4 vCPU, 16GB RAM, 200GB SSD | Xác minh trước (WAS + DB tách biệt) |
| Production - WAS | 2 VM (Active-Active) | 8 vCPU, 32GB RAM, 100GB SSD | Spring Boot API Server (dự phòng) |
| Production - DB | 1 VM (+ Standby) | 8 vCPU, 32GB RAM, 500GB SSD | PostgreSQL Primary + Standby |
| Production - Redis | 1 VM | 4 vCPU, 16GB RAM, 50GB SSD | Redis (Cache/OTP/Session) |
| Production - Nginx | 1 VM | 2 vCPU, 4GB RAM, 50GB SSD | Reverse Proxy, kết thúc SSL |
| Monitoring | 1 VM | 4 vCPU, 8GB RAM, 200GB SSD | Prometheus, Grafana, ELK |

### 7.2 Chiến lược Triển khai
- Phương thức triển khai: **Rolling Update** (Triển khai tuần tự trên 2 instance Spring Boot)
- Chiến lược rollback: Rollback ngay lập tức bằng tag Docker image phiên bản trước (< 5 phút)
- Quy trình triển khai:
  1. MR mã nguồn -> Đánh giá mã -> Merge
  2. Jenkins Build -> Tạo Docker Image -> Registry Push
  3. Tự động triển khai Staging -> Smoke Test
  4. Triển khai Production có phê duyệt -> Rolling Update tuần tự
  5. Xác nhận Health Check -> Hoàn thành triển khai

### 7.3 Chiến lược Sao lưu
| Đối tượng | Phương pháp | Tần suất | Thời gian lưu giữ |
|-----------|-------------|----------|-------------------|
| PostgreSQL | pg_dump sao lưu toàn bộ | 1 lần/ngày (ban đêm) | 30 ngày |
| PostgreSQL | WAL Archive (sao lưu liên tục) | Thời gian thực | 7 ngày |
| Redis | RDB Snapshot | Mỗi 6 giờ | 3 ngày |
| Ảnh LPR | Đồng bộ tệp NAS | 1 lần/ngày | 90 ngày |
| Nhật ký ứng dụng | Thu thập ELK | Thời gian thực | 90 ngày |

### 7.4 Giám sát
| Đối tượng | Công cụ | Điều kiện cảnh báo |
|-----------|---------|-------------------|
| Application | Spring Actuator + Prometheus | Phản hồi API p95 > 1 giây, tỷ lệ lỗi > 1% |
| Database | pg_stat + Prometheus Exporter | Connection > 80%, truy vấn chậm > 3 giây |
| Redis | Redis Exporter | Memory > 80%, Connection > 90% |
| Infrastructure | Node Exporter + Prometheus | CPU > 80%, Memory > 85%, Disk > 90% |
| Thiết bị LPR | Custom Health Check | Mất kết nối, tỷ lệ nhận dạng < 90% |
| Log | ELK + Kibana | Tần suất log ERROR > 10 lần/phút |
| Nginx | Nginx Exporter | Tỷ lệ lỗi 5xx > 0.5%, độ trễ phản hồi > 2 giây |

### 7.5 Ứng phó Sự cố
| Kịch bản | Phương án ứng phó | RTO |
|----------|-------------------|-----|
| Sự cố máy chủ WAS | Nginx tự động failover (Active-Active) | < 30 giây |
| Sự cố DB Primary | Thăng cấp thủ công PostgreSQL Standby | < 30 phút |
| Sự cố Redis | Fallback truy vấn trực tiếp DB, khởi động lại Redis | < 10 phút |
| Sự cố thiết bị LPR | Chuyển sang chế độ cân thủ công (màn hình cảm ứng) | Ngay lập tức |
| Sự cố mạng | CS Trạm cân lưu cache cục bộ, đồng bộ khi phục hồi | < 1 giờ |
| Sự cố toàn hệ thống | Chuyển sang vận hành thủ công (phương thức cũ song song) | Ngay lập tức |

---

## 8. Rủi ro Kỹ thuật (Technical Risks)

| ID | Rủi ro | Mức ảnh hưởng | Khả năng xảy ra | Phương án giảm thiểu |
|----|--------|---------------|-----------------|---------------------|
| TR-001 | Tỷ lệ nhận dạng biển số LPR không đạt (yếu tố môi trường: ban đêm, mưa, ô nhiễm, v.v.) | CAO | TRUNG BÌNH | Xác minh AI kép, xây dựng quy trình thay thế OTP di động, lắp đặt đèn chiếu sáng phụ |
| TR-002 | Độ trễ hiệu suất công cụ nhận dạng AI (không đạt mục tiêu < 3 giây) | CAO | THẤP | Thực hiện benchmark khi lựa chọn công cụ, triển khai máy chủ GPU cục bộ, vận hành mô hình nhẹ song song |
| TR-003 | Giao tiếp RS-232C với bộ hiển thị không ổn định | TRUNG BÌNH | TRUNG BÌNH | Logic thử lại giao tiếp, quản lý timeout, giám sát cổng nối tiếp, dự trữ bộ chuyển đổi |
| TR-004 | Thất bại di chuyển dữ liệu từ hệ thống cũ | CAO | TRUNG BÌNH | Di chuyển theo giai đoạn (đảm bảo khoảng xác minh), kế hoạch rollback, giai đoạn vận hành song song |
| TR-005 | Sự cố dịch vụ bên ngoài Kakao API / SMS | THẤP | TRUNG BÌNH | Đa kênh (SMS thay thế khi Kakao gặp sự cố), hàng đợi thử lại, circuit breaker |
| TR-006 | Tắc nghẽn quy trình cân khi nhiều xe vào cùng lúc | TRUNG BÌNH | THẤP | Xử lý sự kiện bất đồng bộ, quản lý hàng đợi cân, kiểm soát thứ tự vào (thanh chắn) |
| TR-007 | Chậm trễ/không nhận được thông báo đẩy ứng dụng di động | THẤP | TRUNG BÌNH | Sử dụng FCM tin nhắn độ tin cậy cao, hỗ trợ thông báo phụ, fallback polling ứng dụng |
| TR-008 | Vấn đề tương thích OS đa nền tảng Flutter | TRUNG BÌNH | THẤP | Kiểm thử native iOS/Android song song, kiểm thử xây dựng tự động CI, kiểm thử beta |
| TR-009 | Mất kết nối mạng giữa CS Trạm cân và máy chủ | CAO | THẤP | Bộ nhớ đệm cục bộ với tự động đồng bộ khi phục hồi, hỗ trợ chế độ ngoại tuyến, mạng dự phòng |
| TR-010 | Lỗ hổng bảo mật (đánh cắp OTP, vượt qua xác thực) | CAO | THẤP | Giới hạn TTL OTP 5 phút, kiểm soát truy cập dựa trên IP, nhật ký kiểm toán bảo mật, kiểm thử xâm nhập |

---

## 9. Tài liệu Tham khảo

- PRD cơ sở: `workspace/outputs/prd/PRD-20260127-154446.md`
- PRD JSON: `workspace/outputs/prd/PRD-20260127-154446.json`
- Đầu vào gốc: `workspace/inputs/projects/Xây dựng Hệ thống Cân thông minh Busan - Kế hoạch Thực hiện.pptx`

---
*Tài liệu này được tạo bởi hệ thống tự động tạo TRD.*
