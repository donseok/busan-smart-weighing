# Busan Smart Weighing System TRD (Technical Requirements Document)

**Version**: 1.0
**Date**: 2026-01-27
**Based on PRD**: PRD-20260127-154446
**Status**: Draft

---

## 1. Technology Stack

### 1.1 Frontend (Web)
| Category | Technology | Version | Rationale |
|----------|-----------|---------|-----------|
| Framework | React | 18.x | Specified in PRD constraints; component-based SPA well-suited for real-time weighing status dashboard |
| State Management | Zustand | 4.x | Lightweight state management, React 18 compatible, less boilerplate compared to Redux |
| UI Library | Ant Design | 5.x | Enterprise-grade data tables (filter, sort, subtotals, column pinning), built-in chart components |
| Chart Library | Apache ECharts | 5.x | Supports diverse chart types, real-time data visualization, dashboard composition |
| HTTP Client | Axios | 1.x | REST API communication, interceptor-based auth token management |
| Build Tool | Vite | 5.x | Fast HMR, optimized production builds, official React 18 support |
| Language | TypeScript | 5.x | Type safety, improved maintainability for large-scale projects |

### 1.2 Frontend (Mobile APP)
| Category | Technology | Version | Rationale |
|----------|-----------|---------|-----------|
| Framework | Flutter | 3.x | Specified in PRD constraints; iOS/Android cross-platform, single codebase |
| Language | Dart | 3.x | Official Flutter language, AOT compilation performance |
| State Management | Riverpod | 2.x | Type-safe state management, improved version of Provider |
| Push Notification | Firebase Cloud Messaging (FCM) | - | Unified Android/iOS push notifications, Kakao notification integration |
| Local Storage | Hive | 2.x | Lightweight local DB, offline caching |

### 1.3 Backend
| Category | Technology | Version | Rationale |
|----------|-----------|---------|-----------|
| Language | Java | 17 LTS | Default support for Spring Boot 3.x, long-term support version, enterprise standard |
| Framework | Spring Boot | 3.2.x | Specified in PRD constraints; enterprise-grade stability, integrated WEB/WAS |
| Security | Spring Security | 6.x | JWT authentication, RBAC authorization management, OTP security integration |
| ORM | Spring Data JPA + QueryDSL | 3.x / 5.x | Type-safe dynamic queries, support for complex search conditions |
| API Documentation | SpringDoc OpenAPI | 2.x | Auto-generated Swagger UI, standardized API specification |
| Messaging | Spring WebSocket + STOMP | 6.x | Real-time weighing data transmission, H/W status monitoring |
| Scheduling | Spring Scheduler + Quartz | 2.x | Dispatch scheduling, batch notification processing |

### 1.4 Weighing Station CS Program
| Category | Technology | Version | Rationale |
|----------|-----------|---------|-----------|
| IDE | Visual Studio 2022 Professional | 17.x | Specified in PRD constraints; C# development environment |
| Language | C# | 11 (.NET 7+) | Windows-based weighing station PC, serial communication support |
| Framework | .NET WinForms / WPF | 7+ | Touch screen UI, compatible with existing weighing PCs |
| Serial Comm | System.IO.Ports | - | RS-232C indicator communication, LPR/sensor data reception |
| HTTP Client | HttpClient | - | Weighing server REST API integration |

### 1.5 Database
| Category | Technology | Version | Rationale |
|----------|-----------|---------|-----------|
| Primary DB | PostgreSQL | 16.x | Specified in PRD constraints; ACID transactions, JSON support, scalability |
| Cache | Redis | 7.x | OTP temporary storage, session caching, real-time weighing status |
| Message Queue | Redis Streams | 7.x | Asynchronous weighing event processing, H/W to server event delivery |

### 1.6 Infrastructure
| Category | Technology | Rationale |
|----------|-----------|-----------|
| Server OS | CentOS / Rocky Linux 9 | Enterprise on-premises server standard, stability |
| WEB/WAS | Spring Boot Embedded Tomcat | Built into Spring Boot, no separate WAS required |
| Reverse Proxy | Nginx | 1.24.x | SSL termination, load balancing, static file serving |
| Containerization | Docker + Docker Compose | Consistent dev/staging environments, simplified deployment |
| CI/CD | Jenkins / GitLab CI | In-house CI/CD standard, automated build/deployment |
| Monitoring | Prometheus + Grafana | System/application metrics, alerting, dashboards |
| Log Management | ELK Stack (Elasticsearch + Logstash + Kibana) | Centralized logging, search, visualization |
| VCS | Git (GitLab) | Source code version control, code review, MR workflow |

---

## 2. System Architecture

### 2.1 Overall Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Busan Factory Weighing Station Site                      │
│                                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  LPR     │  │ LiDAR    │  │ Radar    │  │ Vehicle  │  │ Indi-    │          │
│  │ Camera   │  │ Sensor   │  │ Sensor   │  │ Detector │  │ cator    │          │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘          │
│       │              │              │              │              │               │
│       └──────────────┴──────────────┴──────────────┴──────────────┘               │
│                                     │                                             │
│                          ┌──────────▼──────────┐                                  │
│                          │  Weighing Station    │◄──── RS-232C (Indicator)        │
│                          │  CS Program          │                                  │
│                          │  (C# / .NET)         │──── TCP/UDP (LPR/Sensors)       │
│                          │  - LPR Auto Weighing │                                  │
│                          │  - Mobile Weighing   │                                  │
│                          │  - Manual Weighing   │                                  │
│                          └──────────┬──────────┘                                  │
│                                     │                                             │
│  ┌──────────┐  ┌──────────┐        │        ┌──────────┐                         │
│  │ Display  │  │ Auto     │        │        │ Intercom │                         │
│  │ Board    │  │ Barrier  │        │        │(Self/Base)│                        │
│  │ (OTP)    │  │          │        │        │          │                         │
│  └──────────┘  └──────────┘        │        └──────────┘                         │
└─────────────────────────────────────┼─────────────────────────────────────────────┘
                                      │ HTTPS (REST API)
                                      │
┌─────────────────────────────────────┼─────────────────────────────────────────────┐
│                              Server Infrastructure                               │
│                                     │                                             │
│              ┌──────────────────────▼──────────────────────┐                      │
│              │              Nginx (Reverse Proxy)          │                      │
│              │         SSL Termination / Load Balancing     │                      │
│              └──────────┬──────────────────┬───────────────┘                      │
│                         │                  │                                       │
│              ┌──────────▼─────┐  ┌────────▼────────┐                              │
│              │  Spring Boot   │  │  Spring Boot    │                              │
│              │  WEB/WAS #1    │  │  WEB/WAS #2     │                              │
│              │  (API Server)  │  │  (API Server)   │                              │
│              └──────┬─────────┘  └────────┬────────┘                              │
│                     │                      │                                       │
│              ┌──────▼──────────────────────▼────────┐                              │
│              │         Service Layer                │                              │
│              │  - Weighing Management Service       │                              │
│              │  - Dispatch Management Service       │                              │
│              │  - User/Auth Service                 │                              │
│              │  - Notification Service              │                              │
│              │  - AI Vehicle Recognition Service    │                              │
│              └──────┬──────────────┬────────────────┘                              │
│                     │              │                                               │
│         ┌───────────▼──┐   ┌──────▼──────┐   ┌───────────┐                       │
│         │ PostgreSQL   │   │   Redis     │   │ AI Recog. │                       │
│         │ (Primary DB) │   │ (Cache/OTP/ │   │ Engine    │                       │
│         │              │   │  MQ/Session)│   │(Ext./Int.)│                       │
│         └──────────────┘   └─────────────┘   └───────────┘                       │
│                                                                                   │
│         ┌───────────────────────────────────────────┐                             │
│         │  Monitoring: Prometheus + Grafana          │                             │
│         │  Logging: ELK Stack                        │                             │
│         └───────────────────────────────────────────┘                             │
└───────────────────────────────────────────────────────────────────────────────────┘
                                      │
                           ┌──────────┼──────────┐
                           │          │          │
                    ┌──────▼──┐ ┌─────▼───┐ ┌───▼──────────┐
                    │ Web     │ │ Mobile  │ │ External     │
                    │ Browser │ │ APP     │ │ Services     │
                    │ (React) │ │(Flutter)│ │              │
                    │         │ │         │ │ - Kakao API  │
                    │         │ │         │ │ - SMS Service│
                    │         │ │         │ │ - FCM/APNs   │
                    └─────────┘ └─────────┘ └──────────────┘
```

### 2.2 Component Descriptions
| Component | Role | Technology |
|-----------|------|------------|
| Weighing Station CS Program | H/W equipment integration, weight value reception, LPR/mobile/manual weighing processing, display board/barrier control | C# .NET WinForms |
| Nginx Reverse Proxy | SSL termination, load balancing, static resource serving, WebSocket proxy | Nginx 1.24 |
| Spring Boot API Server | REST API provision, business logic processing, authentication/authorization, WebSocket | Spring Boot 3.2 |
| AI Vehicle Recognition Engine | Vehicle plate number extraction and verification from LPR captured images, 95%+ recognition rate | External solution or in-house development (TBD) |
| PostgreSQL DB | Persistent storage of core data including dispatches, weighing records, users, master data | PostgreSQL 16 |
| Redis | OTP temporary storage (TTL), session caching, real-time weighing status, event MQ | Redis 7 |
| React Web App | Weighing management web system (dispatch registration, weighing management, master data, gate pass management, dashboard) | React 18 + Ant Design |
| Flutter Mobile App | Weighing management APP (login, dispatch inquiry, weighing progress, electronic weighing slip, OTP) | Flutter 3.x |
| FCM/APNs | Weighing completion push notifications, notification message delivery | Firebase Cloud Messaging |
| Kakao API / SMS | Electronic weighing slip sharing, notification message delivery | Kakao Biz API, SMS Gateway |

### 2.3 Communication Methods
| From | To | Protocol | Description |
|------|-----|---------|------------|
| LPR/Sensor Equipment | Weighing Station CS | TCP/UDP | Vehicle plate recognition data, sensor detection event transmission |
| Indicator | Weighing Station CS | RS-232C (Serial) | Real-time stabilized weight value reception |
| Weighing Station CS | Display Board/Barrier | TCP/RS-485 | OTP display, barrier open/close control commands |
| Weighing Station CS | API Server | HTTPS (REST) | Weighing record transmission, dispatch information inquiry, authentication |
| React Web | API Server | HTTPS (REST) | Dispatch registration, weighing management, master data CRUD |
| React Web | API Server | WSS (WebSocket) | Real-time weighing status, dashboard updates |
| Flutter App | API Server | HTTPS (REST) | Dispatch inquiry, mobile weighing, OTP authentication, electronic weighing slip |
| API Server | PostgreSQL | TCP (5432) | Data read/write, transaction processing |
| API Server | Redis | TCP (6379) | OTP storage/verification, session caching, event publishing |
| API Server | AI Engine | HTTPS (REST) | Vehicle plate image transmission, recognition result reception |
| API Server | Kakao API | HTTPS (REST) | Notification message delivery, weighing slip sharing |
| API Server | SMS Gateway | HTTPS (REST) | SMS notification delivery |
| API Server | FCM | HTTPS | Push notification delivery (Android/iOS) |

---

## 3. Database Design

### 3.1 Entity Relationship Diagram (ERD)

```
┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐
│     tb_user      │       │   tb_company     │       │   tb_vehicle     │
├──────────────────┤       ├──────────────────┤       ├──────────────────┤
│ user_id (PK)     │──┐    │ company_id (PK)  │──┐    │ vehicle_id (PK)  │
│ company_id (FK)  │──┘──▶ │ company_name     │  │    │ plate_number     │
│ user_name        │       │ company_type     │  │    │ company_id (FK)  │──▶
│ phone_number     │       │ contact_phone    │  │    │ vehicle_type     │
│ user_role        │       │ is_active        │  │    │ is_active        │
│ login_id         │       └──────────────────┘  │    └────────┬─────────┘
│ password_hash    │                              │             │
│ is_active        │                              │             │
└──────────────────┘                              │             │
        │                                         │             │
        │                                         │             │
        ▼                                         │             │
┌──────────────────┐       ┌──────────────────┐   │             │
│ tb_otp_session   │       │  tb_dispatch     │   │             │
├──────────────────┤       ├──────────────────┤   │             │
│ otp_id (PK)      │       │ dispatch_id (PK) │   │             │
│ user_id (FK)     │       │ vehicle_id (FK)  │───┘─────────────┘
│ otp_code         │       │ company_id (FK)  │───┘
│ vehicle_id (FK)  │       │ item_type        │
│ expires_at       │       │ item_name        │
│ is_verified      │       │ dispatch_date    │
│ created_at       │       │ dispatch_status  │
└──────────────────┘       │ created_by (FK)  │
                           │ created_at       │
                           └────────┬─────────┘
                                    │
                                    │ 1:N
                                    ▼
                           ┌──────────────────┐       ┌──────────────────┐
                           │ tb_weighing      │       │ tb_weighing_log  │
                           ├──────────────────┤       ├──────────────────┤
                           │ weighing_id (PK) │──────▶│ log_id (PK)      │
                           │ dispatch_id (FK) │       │ weighing_id (FK) │
                           │ vehicle_id (FK)  │       │ log_type         │
                           │ scale_id (FK)    │       │ log_message      │
                           │ weighing_type    │       │ created_at       │
                           │ weighing_step    │       └──────────────────┘
                           │ gross_weight     │
                           │ tare_weight      │       ┌──────────────────┐
                           │ net_weight       │       │ tb_weighing_slip │
                           │ weighing_mode    │       ├──────────────────┤
                           │ lpr_plate_number │──────▶│ slip_id (PK)     │
                           │ ai_confidence    │       │ weighing_id (FK) │
                           │ status           │       │ slip_number      │
                           │ weighed_at       │       │ slip_data (JSON) │
                           │ created_at       │       │ shared_via       │
                           └──────────────────┘       │ shared_at        │
                                    │                 │ created_at       │
                                    │                 └──────────────────┘
                                    │
                           ┌────────▼─────────┐       ┌──────────────────┐
                           │  tb_scale        │       │ tb_gate_pass     │
                           ├──────────────────┤       ├──────────────────┤
                           │ scale_id (PK)    │       │ gate_pass_id(PK) │
                           │ scale_name       │       │ weighing_id (FK) │
                           │ location         │       │ dispatch_id (FK) │
                           │ scale_type       │       │ pass_status      │
                           │ is_active        │       │ passed_at        │
                           └──────────────────┘       │ created_at       │
                                                      └──────────────────┘
┌──────────────────┐       ┌──────────────────┐
│ tb_master_code   │       │ tb_notification  │
├──────────────────┤       ├──────────────────┤
│ code_id (PK)     │       │ noti_id (PK)     │
│ code_group       │       │ user_id (FK)     │
│ code_value       │       │ noti_type        │
│ code_name        │       │ title            │
│ sort_order       │       │ message          │
│ is_active        │       │ is_read          │
│ parent_code_id   │       │ sent_at          │
└──────────────────┘       └──────────────────┘

┌──────────────────┐
│ tb_inquiry_call  │
├──────────────────┤
│ call_id (PK)     │
│ user_id (FK)     │
│ inquiry_type     │
│ target_dept      │
│ call_status      │
│ created_at       │
└──────────────────┘
```

### 3.2 Table Specifications

#### tb_user (User)
| Column | Type | NULL | Default | Description |
|--------|------|------|---------|-------------|
| user_id | BIGSERIAL | NO | AUTO | PK |
| company_id | BIGINT | YES | NULL | FK to tb_company, affiliated transport company |
| user_name | VARCHAR(50) | NO | - | User name |
| phone_number | VARCHAR(20) | NO | - | Phone number (used for mobile OTP authentication) |
| user_role | VARCHAR(20) | NO | - | ADMIN, MANAGER, DRIVER |
| login_id | VARCHAR(50) | NO | - | Login ID |
| password_hash | VARCHAR(255) | NO | - | Password hash (bcrypt) |
| is_active | BOOLEAN | NO | true | Active status |
| created_at | TIMESTAMPTZ | NO | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | NO | NOW() | Updated timestamp |

#### tb_vehicle (Vehicle)
| Column | Type | NULL | Default | Description |
|--------|------|------|---------|-------------|
| vehicle_id | BIGSERIAL | NO | AUTO | PK |
| plate_number | VARCHAR(20) | NO | - | Vehicle plate number (for LPR matching), UNIQUE |
| company_id | BIGINT | YES | NULL | FK to tb_company |
| vehicle_type | VARCHAR(20) | NO | - | Vehicle type |
| max_load_weight | DECIMAL(10,2) | YES | NULL | Maximum load weight (kg) |
| is_active | BOOLEAN | NO | true | Active status |
| created_at | TIMESTAMPTZ | NO | NOW() | Created timestamp |

#### tb_dispatch (Dispatch)
| Column | Type | NULL | Default | Description |
|--------|------|------|---------|-------------|
| dispatch_id | BIGSERIAL | NO | AUTO | PK |
| vehicle_id | BIGINT | NO | - | FK to tb_vehicle |
| company_id | BIGINT | NO | - | FK to tb_company |
| item_type | VARCHAR(20) | NO | - | By-product, Waste, Sub-material, Export, General |
| item_name | VARCHAR(100) | NO | - | Item name |
| dispatch_date | DATE | NO | - | Dispatch date |
| dispatch_status | VARCHAR(20) | NO | REGISTERED | REGISTERED, IN_PROGRESS, COMPLETED, CANCELLED |
| origin_location | VARCHAR(100) | YES | NULL | Origin location |
| destination | VARCHAR(100) | YES | NULL | Destination |
| remarks | TEXT | YES | NULL | Remarks |
| created_by | BIGINT | NO | - | FK to tb_user |
| created_at | TIMESTAMPTZ | NO | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | NO | NOW() | Updated timestamp |

#### tb_weighing (Weighing Record)
| Column | Type | NULL | Default | Description |
|--------|------|------|---------|-------------|
| weighing_id | BIGSERIAL | NO | AUTO | PK |
| dispatch_id | BIGINT | NO | - | FK to tb_dispatch |
| vehicle_id | BIGINT | NO | - | FK to tb_vehicle |
| scale_id | BIGINT | NO | - | FK to tb_scale |
| weighing_type | VARCHAR(20) | NO | - | FIRST, SECOND, THIRD (1st/2nd/3rd weighing) |
| weighing_step | VARCHAR(20) | NO | - | GROSS, TARE, COMPLETE |
| gross_weight | DECIMAL(10,2) | YES | NULL | Gross weight (kg) |
| tare_weight | DECIMAL(10,2) | YES | NULL | Tare weight / vehicle empty weight (kg) |
| net_weight | DECIMAL(10,2) | YES | NULL | Net weight (kg) = gross - tare |
| weighing_mode | VARCHAR(20) | NO | - | LPR_AUTO, MOBILE_OTP, MANUAL, RE_WEIGH |
| lpr_plate_number | VARCHAR(20) | YES | NULL | LPR recognized plate number |
| ai_confidence | DECIMAL(5,4) | YES | NULL | AI plate number recognition confidence (0.0~1.0) |
| lpr_image_path | VARCHAR(500) | YES | NULL | LPR captured image storage path |
| status | VARCHAR(20) | NO | IN_PROGRESS | IN_PROGRESS, COMPLETED, RE_WEIGHING, ERROR |
| weighed_at | TIMESTAMPTZ | YES | NULL | Weighing completion timestamp |
| created_at | TIMESTAMPTZ | NO | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | NO | NOW() | Updated timestamp |

#### tb_weighing_slip (Electronic Weighing Slip)
| Column | Type | NULL | Default | Description |
|--------|------|------|---------|-------------|
| slip_id | BIGSERIAL | NO | AUTO | PK |
| weighing_id | BIGINT | NO | - | FK to tb_weighing |
| slip_number | VARCHAR(30) | NO | - | Weighing slip number (auto-generated), UNIQUE |
| slip_data | JSONB | NO | - | Weighing slip detail data (JSON) |
| shared_via | VARCHAR(20) | YES | NULL | KAKAO, SMS, NONE |
| shared_at | TIMESTAMPTZ | YES | NULL | Shared timestamp |
| created_at | TIMESTAMPTZ | NO | NOW() | Created timestamp |

#### tb_otp_session (OTP Session)
| Column | Type | NULL | Default | Description |
|--------|------|------|---------|-------------|
| otp_id | BIGSERIAL | NO | AUTO | PK |
| user_id | BIGINT | YES | NULL | FK to tb_user |
| otp_code | VARCHAR(6) | NO | - | 6-digit OTP code |
| vehicle_id | BIGINT | YES | NULL | FK to tb_vehicle |
| phone_number | VARCHAR(20) | NO | - | Authentication phone number |
| expires_at | TIMESTAMPTZ | NO | - | Expiration time (5 minutes after creation) |
| is_verified | BOOLEAN | NO | false | Verification completion status |
| created_at | TIMESTAMPTZ | NO | NOW() | Created timestamp |

#### tb_scale (Weighing Scale)
| Column | Type | NULL | Default | Description |
|--------|------|------|---------|-------------|
| scale_id | BIGSERIAL | NO | AUTO | PK |
| scale_name | VARCHAR(50) | NO | - | Scale name |
| location | VARCHAR(100) | NO | - | Installation location |
| scale_type | VARCHAR(20) | NO | - | SMART, MANUAL |
| max_capacity | DECIMAL(10,2) | YES | NULL | Maximum capacity (kg) |
| is_active | BOOLEAN | NO | true | Operational status |
| last_calibrated_at | TIMESTAMPTZ | YES | NULL | Last calibration timestamp |

### 3.3 Index Strategy
| Table | Index Name | Columns | Type | Purpose |
|-------|-----------|---------|------|---------|
| tb_vehicle | idx_vehicle_plate | plate_number | B-Tree UNIQUE | LPR plate number matching (critical query) |
| tb_dispatch | idx_dispatch_date_status | dispatch_date, dispatch_status | B-Tree | Daily dispatch status query |
| tb_dispatch | idx_dispatch_vehicle | vehicle_id | B-Tree | Vehicle dispatch history |
| tb_dispatch | idx_dispatch_company | company_id | B-Tree | Company dispatch query |
| tb_weighing | idx_weighing_dispatch | dispatch_id | B-Tree | Weighing records by dispatch |
| tb_weighing | idx_weighing_vehicle | vehicle_id | B-Tree | Vehicle weighing history |
| tb_weighing | idx_weighing_date | weighed_at | B-Tree | Period-based performance query |
| tb_weighing | idx_weighing_status | status | B-Tree | Status-based filtering |
| tb_weighing | idx_weighing_mode | weighing_mode | B-Tree | Weighing mode statistics |
| tb_weighing_slip | idx_slip_number | slip_number | B-Tree UNIQUE | Weighing slip number search |
| tb_otp_session | idx_otp_code_expires | otp_code, expires_at | B-Tree | OTP code verification |
| tb_otp_session | idx_otp_phone | phone_number | B-Tree | Phone number-based OTP lookup |
| tb_user | idx_user_login | login_id | B-Tree UNIQUE | Login ID lookup |
| tb_user | idx_user_phone | phone_number | B-Tree | Phone number-based user lookup |
| tb_notification | idx_noti_user_read | user_id, is_read | B-Tree | Unread notifications per user |

---

## 4. API Specification

### 4.1 Common Details
- Base URL: `/api/v1`
- Authentication: Bearer Token (JWT) - Access Token (30 min) + Refresh Token (7 days)
- Response format: JSON (application/json)
- Common response structure:

```json
{
  "success": true,
  "data": { ... },
  "message": "Success",
  "timestamp": "2026-01-27T15:00:00+09:00"
}
```

- Common error response:

```json
{
  "success": false,
  "error": {
    "code": "ERR_001",
    "message": "Error description"
  },
  "timestamp": "2026-01-27T15:00:00+09:00"
}
```

### 4.2 Authentication API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | /auth/login | Login (ID/PW) | Not Required |
| POST | /auth/login/otp | OTP-based login (mobile) | Not Required |
| POST | /auth/refresh | Access Token renewal | Refresh Token |
| POST | /auth/logout | Logout | Required |

##### POST /auth/login
**Request**:
```json
{
  "login_id": "string",
  "password": "string",
  "device_type": "WEB | MOBILE"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "access_token": "jwt_token",
    "refresh_token": "refresh_token",
    "user": {
      "user_id": 1,
      "user_name": "Hong Gildong",
      "user_role": "DRIVER",
      "company_name": "ABC Transport"
    },
    "expires_in": 1800
  }
}
```

### 4.3 Dispatch Management API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /dispatches | Dispatch list query | Required |
| POST | /dispatches | Create dispatch | Required (ADMIN, MANAGER) |
| GET | /dispatches/{id} | Dispatch detail query | Required |
| PUT | /dispatches/{id} | Update dispatch | Required (ADMIN, MANAGER) |
| DELETE | /dispatches/{id} | Delete dispatch | Required (ADMIN) |
| GET | /dispatches/my | My dispatch list (driver) | Required (DRIVER) |

##### GET /dispatches
**Query Parameters**:
- `dispatch_date` (date, optional): Dispatch date filter
- `item_type` (string, optional): Item type filter
- `status` (string, optional): Status filter
- `company_id` (integer, optional): Transport company filter
- `page` (integer, default: 1): Page number
- `size` (integer, default: 20): Page size

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "dispatch_id": 1,
        "vehicle_plate": "12ga3456",
        "company_name": "ABC Transport",
        "item_type": "By-product",
        "item_name": "Slag",
        "dispatch_date": "2026-01-27",
        "dispatch_status": "REGISTERED"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total_count": 150,
      "total_pages": 8
    }
  }
}
```

### 4.4 Weighing Management API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | /weighings | Start weighing (LPR auto/mobile/manual) | Required |
| PUT | /weighings/{id}/complete | Complete weighing | Required |
| PUT | /weighings/{id}/re-weigh | Re-weigh processing | Required |
| GET | /weighings | Weighing record list query | Required |
| GET | /weighings/{id} | Weighing detail query | Required |
| GET | /weighings/realtime | Real-time weighing status (WebSocket upgrade) | Required |
| GET | /weighings/statistics | Weighing statistics (daily/monthly/by item) | Required |

##### POST /weighings
**Request**:
```json
{
  "dispatch_id": 1,
  "scale_id": 1,
  "weighing_mode": "LPR_AUTO | MOBILE_OTP | MANUAL",
  "weighing_type": "FIRST | SECOND | THIRD",
  "weight_value": 15000.50,
  "lpr_plate_number": "12ga3456",
  "ai_confidence": 0.9823
}
```

### 4.5 OTP Authentication API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | /otp/generate | Generate OTP (for display board) | Internal |
| POST | /otp/verify | Verify OTP (mobile input) | Not Required |

##### POST /otp/verify
**Request**:
```json
{
  "otp_code": "123456",
  "phone_number": "010-1234-5678"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "verified": true,
    "vehicle_id": 1,
    "plate_number": "12ga3456",
    "dispatch_id": 5
  }
}
```

### 4.6 Electronic Weighing Slip API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /slips/{weighing_id} | Get electronic weighing slip | Required |
| POST | /slips/{slip_id}/share | Share weighing slip (KakaoTalk/SMS) | Required |
| GET | /slips/history | Weighing slip history query | Required |

### 4.7 Notification API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /notifications | Notification list query | Required |
| PUT | /notifications/{id}/read | Mark notification as read | Required |
| POST | /notifications/push/register | Register FCM token | Required |

### 4.8 Master Data API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /master/companies | Transport company list | Required |
| GET | /master/vehicles | Vehicle list | Required |
| GET | /master/scales | Weighing scale list | Required |
| GET | /master/codes/{group} | Common code query | Required |
| POST | /master/companies | Register transport company | Required (ADMIN) |
| POST | /master/vehicles | Register vehicle | Required (ADMIN) |

### 4.9 Gate Pass Management API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /gate-passes | Gate pass list query | Required |
| POST | /gate-passes | Process gate pass | Required (MANAGER) |
| PUT | /gate-passes/{id} | Update gate pass status | Required (MANAGER) |

### 4.10 Inquiry/Call API

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /inquiries/contacts | Contact list by inquiry type | Required |
| POST | /inquiries/call-log | Record call history | Required |

---

## 5. Security Requirements

### 5.1 Authentication/Authorization
| Item | Implementation |
|------|---------------|
| Authentication | JWT (Access Token 30 min + Refresh Token 7 days) |
| Authorization | RBAC - ADMIN (System Administrator), MANAGER (Weighing Operator), DRIVER (Driver) |
| Session Management | Redis-based Refresh Token storage, concurrent session limitation |
| OTP Authentication | TOTP-based 6-digit number, 5-minute validity, Redis TTL management |
| Mobile Authentication | Phone number + verification code based secure login |

### 5.2 Data Security
| Item | Implementation |
|------|---------------|
| Transport Encryption | TLS 1.3 (Nginx SSL termination) |
| Password Storage | bcrypt (cost factor 12) |
| Personal Information | Phone number, plate number masking (logs, screen display) |
| DB Encryption | AES-256 encryption on sensitive columns (phone_number, etc.) |
| API Key Management | Spring Vault or environment variable-based secret management |

### 5.3 Security Policies
- [x] OWASP Top 10 mitigation (Spring Security default coverage)
- [x] SQL Injection prevention (JPA Parameterized Query)
- [x] XSS prevention (React auto-escaping + CSP headers)
- [x] CSRF prevention (JWT-based Stateless, SameSite Cookie)
- [x] Rate Limiting (Nginx limit_req, differentiated by API)
- [x] CORS policy (allowed Origin whitelist)
- [x] Input validation (Bean Validation, DTO validation)
- [x] Audit logging (login/weighing/dispatch change history recording)

### 5.4 Network Security
| Item | Implementation |
|------|---------------|
| Firewall | Allow only required ports between servers (5432, 6379, 8080, 443) |
| VPN | Internal network VPN connection between Weighing Station CS and server |
| DB Access | Access allowed only from application servers |
| External API | Whitelist-based outbound access (Kakao, FCM) |

---

## 6. Performance Requirements

### 6.1 Response Time
| Category | Target | Measurement Method |
|----------|--------|-------------------|
| LPR Recognition to Auto Weighing Completion | < 3 sec (E2E) | Application log timestamps |
| API Response (p50) | < 200ms | Prometheus + Spring Actuator |
| API Response (p95) | < 500ms | Prometheus + Spring Actuator |
| API Response (p99) | < 1,000ms | Prometheus + Spring Actuator |
| Web Page Load (FCP) | < 2 sec | Lighthouse |
| Web Page Load (LCP) | < 3 sec | Lighthouse |
| Mobile APP Screen Transition | < 1 sec | Flutter DevTools |
| WebSocket Data Delivery | < 500ms | Server logs |

### 6.2 Throughput
| Category | Target |
|----------|--------|
| Concurrent Web Users | 50+ |
| Concurrent Mobile Users | 200+ |
| API TPS (Normal) | 100 TPS |
| API TPS (Peak) | 300 TPS |
| Daily Weighing Transactions | 500+ |

### 6.3 Optimization Strategies
- [x] Redis Caching: Master data, dispatch list, vehicle information (TTL 5 min)
- [x] Database Connection Pooling: HikariCP (min: 10, max: 30)
- [x] Query Optimization: QueryDSL dynamic queries, pagination, index utilization
- [x] Static Resource CDN: Nginx static file caching (JS/CSS/Image)
- [x] API Response Compression: Gzip (Nginx)
- [x] Lazy Loading: React component code splitting
- [x] DB Read Replica: Read load distribution (future expansion)
- [x] Image Optimization: LPR captured image resize on storage

---

## 7. Infrastructure Requirements

### 7.1 Server Configuration
| Environment | Configuration | Specs | Purpose |
|-------------|--------------|-------|---------|
| Development | 1 VM | 4 vCPU, 16GB RAM, 200GB SSD | Integrated dev/test environment |
| Staging | 2 VMs | 4 vCPU, 16GB RAM, 200GB SSD | Pre-validation (WAS + DB separated) |
| Production - WAS | 2 VMs (Active-Active) | 8 vCPU, 32GB RAM, 100GB SSD | Spring Boot API Server (redundant) |
| Production - DB | 1 VM (+ Standby) | 8 vCPU, 32GB RAM, 500GB SSD | PostgreSQL Primary + Standby |
| Production - Redis | 1 VM | 4 vCPU, 16GB RAM, 50GB SSD | Redis (Cache/OTP/Session) |
| Production - Nginx | 1 VM | 2 vCPU, 4GB RAM, 50GB SSD | Reverse Proxy, SSL termination |
| Monitoring | 1 VM | 4 vCPU, 8GB RAM, 200GB SSD | Prometheus, Grafana, ELK |

### 7.2 Deployment Strategy
- Deployment method: **Rolling Update** (Sequential deployment across 2 Spring Boot instances)
- Rollback strategy: Immediate rollback to previous Docker image tag (< 5 min)
- Deployment process:
  1. Code MR -> Code Review -> Merge
  2. Jenkins Build -> Docker Image Creation -> Registry Push
  3. Staging Auto-deployment -> Smoke Test
  4. Production Approval Deployment -> Sequential Rolling Update
  5. Health Check Verification -> Deployment Complete

### 7.3 Backup Strategy
| Target | Method | Frequency | Retention |
|--------|--------|-----------|-----------|
| PostgreSQL | pg_dump full backup | Daily (overnight) | 30 days |
| PostgreSQL | WAL Archive (continuous backup) | Real-time | 7 days |
| Redis | RDB Snapshot | Every 6 hours | 3 days |
| LPR Images | NAS file synchronization | Daily | 90 days |
| Application Logs | ELK collection | Real-time | 90 days |

### 7.4 Monitoring
| Target | Tool | Alert Conditions |
|--------|------|-----------------|
| Application | Spring Actuator + Prometheus | API response p95 > 1 sec, error rate > 1% |
| Database | pg_stat + Prometheus Exporter | Connection > 80%, slow query > 3 sec |
| Redis | Redis Exporter | Memory > 80%, Connection > 90% |
| Infrastructure | Node Exporter + Prometheus | CPU > 80%, Memory > 85%, Disk > 90% |
| LPR Equipment | Custom Health Check | Connection lost, recognition rate < 90% |
| Log | ELK + Kibana | ERROR log frequency > 10/min |
| Nginx | Nginx Exporter | 5xx error rate > 0.5%, response delay > 2 sec |

### 7.5 Disaster Recovery
| Scenario | Response Plan | RTO |
|---------|--------------|-----|
| WAS Server Failure | Nginx auto failover (Active-Active) | < 30 sec |
| DB Primary Failure | PostgreSQL Standby manual promotion | < 30 min |
| Redis Failure | Direct DB query fallback, Redis restart | < 10 min |
| LPR Equipment Failure | Switch to manual weighing mode (touch screen) | Immediate |
| Network Failure | Weighing Station CS local caching, sync on recovery | < 1 hour |
| Full System Failure | Switch to manual operations (parallel legacy method) | Immediate |

---

## 8. Technical Risks

| ID | Risk | Impact | Likelihood | Mitigation |
|----|------|--------|------------|-----------|
| TR-001 | LPR plate recognition rate below target (environmental factors: nighttime, rain, contamination, etc.) | HIGH | MEDIUM | AI verification redundancy, mobile OTP fallback process, supplementary lighting installation |
| TR-002 | AI recognition engine performance delay (< 3 sec target missed) | HIGH | LOW | Benchmark during engine selection, local GPU server deployment, lightweight model parallel operation |
| TR-003 | RS-232C indicator communication instability | MEDIUM | MEDIUM | Communication retry logic, timeout management, serial port monitoring, spare converter procurement |
| TR-004 | Legacy system data migration failure | HIGH | MEDIUM | Phased migration (with validation periods), rollback plan, parallel operation period |
| TR-005 | Kakao API / SMS external service outage | LOW | MEDIUM | Multi-channel (SMS fallback when Kakao fails), retry queue, circuit breaker |
| TR-006 | Weighing process bottleneck during simultaneous multi-vehicle entry | MEDIUM | LOW | Asynchronous event processing, weighing queue management, entry sequence control (barrier) |
| TR-007 | Mobile APP push notification delay/non-delivery | LOW | MEDIUM | FCM high-reliability messaging, notification message backup, APP polling fallback |
| TR-008 | Flutter cross-platform OS compatibility issues | MEDIUM | LOW | iOS/Android native testing in parallel, CI auto build testing, beta testing |
| TR-009 | Network disconnection between Weighing Station CS and server | HIGH | LOW | Local caching with auto-sync on recovery, offline mode support, network redundancy |
| TR-010 | Security vulnerabilities (OTP interception, authentication bypass) | HIGH | LOW | OTP TTL 5 min limit, IP-based access control, security audit logging, penetration testing |

---

## 9. Reference Documents

- Based on PRD: `workspace/outputs/prd/PRD-20260127-154446.md`
- PRD JSON: `workspace/outputs/prd/PRD-20260127-154446.json`
- Original input: `workspace/inputs/projects/Busan Smart Weighing System Construction - Execution Plan.pptx`

---
*This document was generated by the TRD automatic generation system.*
